<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Protobuf Name Conflict 分析与解决 | 极客之道</title><meta name="keywords" content="Protobuf Name Conflict冲突"><meta name="author" content="ivansli"><meta name="copyright" content="ivansli"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Protobuf Name Conflict 分析与解决"><meta name="application-name" content="Protobuf Name Conflict 分析与解决"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Protobuf Name Conflict 分析与解决"><meta property="og:url" content="https://blog.ivansli.com/2022/08/07/grpc-conflict/index.html"><meta property="og:site_name" content="极客之道"><meta property="og:description" content="Protobuf Name Conflict"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://blog.ivansli.com/img/2022/08/1392790189.png"><meta property="article:author" content="ivansli"><meta property="article:tag" content="伊万的小站,ivansli,编程技术,编程技术之道,编程原理,go开发技巧"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.ivansli.com/img/2022/08/1392790189.png"><meta name="description" content="Protobuf Name Conflict"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.ivansli.com/2022/08/07/grpc-conflict/"><link rel="preconnect"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: undefined,
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: undefined,
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏃 脚踏实地行动派"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: ivansli","link":"链接: ","source":"来源: 极客之道","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '极客之道',
  title: 'Protobuf Name Conflict 分析与解决',
  postAI: '',
  pageFillDescription: '问题背景, 分析过程, How do I fix a protocol buffer namespace conflict?, 解决办法, 扩展知识问题背景最近在对老项目进行重构工作在重构过程中发现需要通过调用若干远端微服务远端微服务都有提前定义好的在运行时编译通过运行则出现了冲突问题也就是说在运行时报错提示存在相同名称的消息体具体报错信息如下所示微服务与微服务的中定义的名称都叫并且都存在一个同名的消息体由于是老的项目并且已经按照现有定义的格式与接口对外服务了很长时间所以这个时候再修改包名称名称则不可行分析了一下既然老的项目可以正常运行则意味着可能是由于所依赖的的某些包的版本不同导致以前的项目可运行现在重构时却出现由于项目久远没有文档没有注释没人交接对于这种三无项目只能靠自己摸索分析过程通过报错信息显示的调用栈可以看出最终是在这行代码处抛出的其源码如下行就是这里找到源码之后可以看出对于这种冲突其实存在几种处理策略如果存在环境变量则会根据环境变量具体值进行不同处理环境变量值为则会在运行时环境变量值为则仅仅会输出一个提示信息环境变量值为则会直接忽略提示信息也没有默认使用同时也发现上面逻辑是包的版本于是就分别找出版本中对应的逻辑版本版本可以明显的看出在不同的版本中处理冲突的方式大有不同在中还只是输出一段提示信息在以及之后的版本就会根据不同的策略进行处理最近几个版本的发布时间如下图所示针对此问题官方也有一个说明文档解决办法通过上面分析可知在不同版本的包中处理策略也不同所以可以通过设置环境变量降低版本来解决设置环境变量编译时运行时降低版本在中添加降低包的版本添加之后执行然后重新编译运行目前笔者这里使用的方式通过降低版本来解决问题扩展知识关于的与区别模块是原始的协议缓冲区模块是此的更新版本其设计宗旨是简单易于使用和安全更新后的的主要特性是支持反射并将面向用户的与底层实现分离建议在新代码中使用的及更高版本包装了新的实现并允许程序以增量方式采用新的例如在中定义的知名类型只是在新模块中定义的那些类型的别名因此和可以互换使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-08 15:38:53',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">极客之道</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="anzhiyufont anzhiyu-icon-house-chimney faa-tada"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/booklist/"><i class="anzhiyufont anzhiyu-icon-book faa-tada"></i><span> 书单</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada"></i><span> 关于</span></a></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/golang/" itemprop="url">golang</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/golang/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>golang</span></a><a class="article-meta__tags" href="/tags/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>常见问题</span></a><a class="article-meta__tags" href="/tags/grpc-go/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>grpc-go</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Protobuf Name Conflict 分析与解决</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2022-08-06T16:00:00.000Z" title="发表于 2022-08-07 00:00:00">2022-08-07</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-07-08T07:38:53.306Z" title="更新于 2024-07-08 15:38:53">2024-07-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">2.2k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>10分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="Protobuf Name Conflict 分析与解决"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为上海"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>上海</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/2022/08/1392790189.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.ivansli.com/2022/08/07/grpc-conflict/"><header><a class="post-meta-categories" href="/categories/golang/" itemprop="url">golang</a><a href="/tags/golang/" tabindex="-1" itemprop="url">golang</a><a href="/tags/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" tabindex="-1" itemprop="url">常见问题</a><a href="/tags/grpc-go/" tabindex="-1" itemprop="url">grpc-go</a><h1 id="CrawlerTitle" itemprop="name headline">Protobuf Name Conflict 分析与解决</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">ivansli</span><time itemprop="dateCreated datePublished" datetime="2022-08-06T16:00:00.000Z" title="发表于 2022-08-07 00:00:00">2022-08-07</time><time itemprop="dateCreated datePublished" datetime="2024-07-08T07:38:53.306Z" title="更新于 2024-07-08 15:38:53">2024-07-08</time></header><h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>最近，在对老项目进行重构工作。在重构过程中发现需要通过 grpc 调用若干远端微服务，远端微服务都有提前定义好的 proto，在运行时（编译通过，运行则panic）出现了 <code>name conflict</code> 冲突问题。也就是说，在运行时报错提示存在相同名称的 message 消息体。</p>
<p>具体报错信息，如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  app &gt; <span class="keyword">go</span> mod tidy      </span><br><span class="line">➜  app &gt; <span class="keyword">go</span> build main.<span class="keyword">go</span> </span><br><span class="line">➜  app &gt; ./main api start</span><br><span class="line"></span><br><span class="line"><span class="built_in">panic</span>: proto: file <span class="string">&quot;usermgt.proto&quot;</span> has a name conflict over pb.Response</span><br><span class="line">        previously from: <span class="string">&quot;eslServer/pkg/microgrpc/merchant/pb&quot;</span></span><br><span class="line">        currently from:  <span class="string">&quot;eslServer/pkg/microgrpc/usermgt/pb&quot;</span></span><br><span class="line">See https:<span class="comment">//developers.google.com/protocol-buffers/docs/reference/go/faq#namespace-conflict</span></span><br><span class="line"></span><br><span class="line">goroutine <span class="number">1</span> [running]:</span><br><span class="line">google.golang.org/protobuf/reflect/protoregistry.glob..func1(&#123;<span class="number">0x1fcfb20</span>?, <span class="number">0xc00046c350</span>?&#125;, &#123;<span class="number">0x1fcfb20</span>?, <span class="number">0xc00046c390</span>&#125;)</span><br><span class="line">        /Users/ivanli/<span class="keyword">go</span>/pkg/mod/google.golang.org/protobuf@v1<span class="number">.27</span><span class="number">.1</span>/reflect/protoregistry/registry.<span class="keyword">go</span>:<span class="number">54</span> +<span class="number">0x1ee</span></span><br><span class="line">google.golang.org/protobuf/reflect/protoregistry.(*Files).RegisterFile.func1(&#123;<span class="number">0x1fdca28</span>, <span class="number">0xc0001f51c0</span>&#125;)</span><br><span class="line">        /Users/ivanli/<span class="keyword">go</span>/pkg/mod/google.golang.org/protobuf@v1<span class="number">.27</span><span class="number">.1</span>/reflect/protoregistry/registry.<span class="keyword">go</span>:<span class="number">152</span> +<span class="number">0x279</span></span><br><span class="line">google.golang.org/protobuf/reflect/protoregistry.rangeTopLevelDescriptors(&#123;<span class="number">0x1fdfa10</span>, <span class="number">0xc0005ae000</span>&#125;, <span class="number">0xc0005453b8</span>)</span><br><span class="line">        /Users/ivanli/<span class="keyword">go</span>/pkg/mod/google.golang.org/protobuf@v1<span class="number">.27</span><span class="number">.1</span>/reflect/protoregistry/registry.<span class="keyword">go</span>:<span class="number">415</span> +<span class="number">0x174</span></span><br><span class="line">google.golang.org/protobuf/reflect/protoregistry.(*Files).RegisterFile(<span class="number">0xc000594048</span>, &#123;<span class="number">0x1fdfa10</span>?, <span class="number">0xc0005ae000</span>?&#125;)</span><br><span class="line">        /Users/ivanli/<span class="keyword">go</span>/pkg/mod/google.golang.org/protobuf@v1<span class="number">.27</span><span class="number">.1</span>/reflect/protoregistry/registry.<span class="keyword">go</span>:<span class="number">147</span> +<span class="number">0x739</span></span><br><span class="line">google.golang.org/protobuf/internal/filedesc.Builder.Build(&#123;&#123;<span class="number">0x1bcc89c</span>, <span class="number">0x22</span>&#125;, &#123;<span class="number">0x284a380</span>, <span class="number">0x6ef</span>, <span class="number">0x6ef</span>&#125;, <span class="number">0x0</span>, <span class="number">0xd</span>, <span class="number">0x0</span>, <span class="number">0x1</span>, &#123;<span class="number">0x1fd3e50</span>, ...&#125;, ...&#125;)</span><br><span class="line">        /Users/ivanli/<span class="keyword">go</span>/pkg/mod/google.golang.org/protobuf@v1<span class="number">.27</span><span class="number">.1</span>/internal/filedesc/build.<span class="keyword">go</span>:<span class="number">113</span> +<span class="number">0x1d6</span></span><br><span class="line">google.golang.org/protobuf/internal/filetype.Builder.Build(&#123;&#123;&#123;<span class="number">0x1bcc89c</span>, <span class="number">0x22</span>&#125;, &#123;<span class="number">0x284a380</span>, <span class="number">0x6ef</span>, <span class="number">0x6ef</span>&#125;, <span class="number">0x0</span>, <span class="number">0xd</span>, <span class="number">0x0</span>, <span class="number">0x1</span>, &#123;<span class="number">0x0</span>, ...&#125;, ...&#125;, ...&#125;)</span><br><span class="line">        /Users/ivanli/<span class="keyword">go</span>/pkg/mod/google.golang.org/protobuf@v1<span class="number">.27</span><span class="number">.1</span>/internal/filetype/build.<span class="keyword">go</span>:<span class="number">139</span> +<span class="number">0x19d</span></span><br><span class="line">eslServer/pkg/microgrpc/usermgt/pb.file_usermgt_proto_init()</span><br><span class="line">        /Users/ivanli/code/xxxx/esl-server/app/pkg/microgrpc/usermgt/pb/usermgt.pb.<span class="keyword">go</span>:<span class="number">1179</span> +<span class="number">0x19a</span></span><br><span class="line">eslServer/pkg/microgrpc/usermgt/pb.init<span class="number">.0</span>()</span><br><span class="line">        /Users/ivanli/code/xxxx/esl-server/app/pkg/microgrpc/usermgt/pb/usermgt.pb.<span class="keyword">go</span>:<span class="number">1003</span> +<span class="number">0x17</span></span><br></pre></td></tr></table></figure>

<p>微服务merchant与微服务usermgt的proto中定义的 package 名称都叫 pb，并且都存在一个同名的 Response message 消息体。由于是老的项目，并且已经按照现有 proto 定义的格式与接口对外服务了很长时间。所以，这个时候再修改包名称、message名称则不可行。</p>
<p>分析了一下，既然老的项目可以正常运行，则意味着可能是由于所依赖的的某些包的版本不同导致以前的项目可运行，现在重构时却出现panic。</p>
<blockquote>
<p>由于项目久远，没有文档，没有注释，没人交接。对于这种三无项目，只能靠自己摸索。</p>
</blockquote>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><p>通过报错信息显示的调用栈可以看出，最终是在 <code>/Users/ivanli/go/pkg/mod/google.golang.org/protobuf@v1.27.1/reflect/protoregistry/registry.go:54</code> 这行代码处抛出的panic，其源码如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ignoreConflict reports whether to ignore a registration conflict</span></span><br><span class="line"><span class="comment">// given the descriptor being registered and the error.</span></span><br><span class="line"><span class="comment">// It is a variable so that the behavior is easily overridden in another file.</span></span><br><span class="line"><span class="keyword">var</span> ignoreConflict = <span class="function"><span class="keyword">func</span><span class="params">(d protoreflect.Descriptor, err <span class="type">error</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> env = <span class="string">&quot;GOLANG_PROTOBUF_REGISTRATION_CONFLICT&quot;</span></span><br><span class="line">	<span class="keyword">const</span> faq = <span class="string">&quot;https://developers.google.com/protocol-buffers/docs/reference/go/faq#namespace-conflict&quot;</span></span><br><span class="line">	policy := conflictPolicy</span><br><span class="line">	<span class="keyword">if</span> v := os.Getenv(env); v != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		policy = v</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> policy &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;panic&quot;</span>:</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;%v\nSee %v\n&quot;</span>, err, faq))  <span class="comment">// 54行 就是这里</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;warn&quot;</span>:</span><br><span class="line">		fmt.Fprintf(os.Stderr, <span class="string">&quot;WARNING: %v\nSee %v\n\n&quot;</span>, err, faq)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;ignore&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;invalid &quot;</span> + env + <span class="string">&quot; value: &quot;</span> + os.Getenv(env))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到源码之后，可以看出对于这种冲突其实存在几种处理策略：</p>
<ol>
<li>如果存在环境变量 <code>GOLANG_PROTOBUF_REGISTRATION_CONFLICT</code>，则会根据环境变量具体值进行不同处理</li>
</ol>
<ul>
<li>环境变量值为：panic，则会在运行时 panic</li>
<li>环境变量值为：warn，则仅仅会输出一个提示信息</li>
<li>环境变量值为：ignore，则会直接忽略（提示信息也没有）</li>
</ul>
<ol start="2">
<li>默认使用 panic</li>
</ol>
<p>同时也发现，上面逻辑是 <code>google.golang.org/protobuf</code> 包的 <code>v1.27.1</code> 版本。于是，就分别找出版本<code>v1.26.0</code>、<code>v1.25.0</code> 中对应的逻辑。</p>
<p><code>v1.26.0</code>版本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ignoreConflict reports whether to ignore a registration conflict</span></span><br><span class="line"><span class="comment">// given the descriptor being registered and the error.</span></span><br><span class="line"><span class="comment">// It is a variable so that the behavior is easily overridden in another file.</span></span><br><span class="line"><span class="keyword">var</span> ignoreConflict = <span class="function"><span class="keyword">func</span><span class="params">(d protoreflect.Descriptor, err <span class="type">error</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">const</span> env = <span class="string">&quot;GOLANG_PROTOBUF_REGISTRATION_CONFLICT&quot;</span></span><br><span class="line">	<span class="keyword">const</span> faq = <span class="string">&quot;https://developers.google.com/protocol-buffers/docs/reference/go/faq#namespace-conflict&quot;</span></span><br><span class="line">	policy := conflictPolicy</span><br><span class="line">	<span class="keyword">if</span> v := os.Getenv(env); v != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		policy = v</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> policy &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;panic&quot;</span>:</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;%v\nSee %v\n&quot;</span>, err, faq))</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;warn&quot;</span>:</span><br><span class="line">		fmt.Fprintf(os.Stderr, <span class="string">&quot;WARNING: %v\nSee %v\n\n&quot;</span>, err, faq)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;ignore&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;invalid &quot;</span> + env + <span class="string">&quot; value: &quot;</span> + os.Getenv(env))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>v1.25.0</code>版本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ignoreConflict reports whether to ignore a registration conflict</span></span><br><span class="line"><span class="comment">// given the descriptor being registered and the error.</span></span><br><span class="line"><span class="comment">// It is a variable so that the behavior is easily overridden in another file.</span></span><br><span class="line"><span class="keyword">var</span> ignoreConflict = <span class="function"><span class="keyword">func</span><span class="params">(d protoreflect.Descriptor, err <span class="type">error</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;&quot;</span>+</span><br><span class="line">		<span class="string">&quot;WARNING: %v\n&quot;</span>+</span><br><span class="line">		<span class="string">&quot;A future release will panic on registration conflicts. See:\n&quot;</span>+</span><br><span class="line">		<span class="string">&quot;https://developers.google.com/protocol-buffers/docs/reference/go/faq#namespace-conflict\n&quot;</span>+</span><br><span class="line">		<span class="string">&quot;\n&quot;</span>, err)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以明显的看出，在不同的版本中处理冲突的方式大有不同。在 <code>v1.25.0</code> 中还只是输出一段提示信息。在 <code>v1.26.0</code>以及之后的版本就会根据不同的策略进行处理。</p>
<p>最近几个版本的发布时间如下图所示：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/08/1392790189.png"></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf-go/tags">https://github.com/protocolbuffers/protobuf-go/tags</a></p>
</blockquote>
<p>针对此问题，官方也有一个说明文档：</p>
<blockquote>
<p><code>https://developers.google.cn/protocol-buffers/docs/reference/go/faq</code><br><code>https://developers.google.com/protocol-buffers/docs/reference/go/faq#namespace-conflict</code></p>
</blockquote>
<h3 id="How-do-I-fix-a-protocol-buffer-namespace-conflict"><a href="#How-do-I-fix-a-protocol-buffer-namespace-conflict" class="headerlink" title="How do I fix a protocol buffer namespace conflict?"></a>How do I fix a protocol buffer namespace conflict?</h3><p>The way to best fix a namespace conflict depends on the reason why a conflict is occurring.<br>Common ways that namespace conflicts occur:</p>
<ul>
<li><p>Vendored .proto files. When a single .proto file is generated into two or more Go packages and linked into the same Go binary, it conflicts on every protobuf declaration in the generated Go packages. This typically occurs when a .proto file is vendored and a Go package is generated from it, or the generated Go package itself is vendored. Users should avoid vendoring and instead depend on a centralized Go package for that .proto file.</p>
<ul>
<li>If a .proto file is owned by an external party and is lacking a go_package option, then you should coordinate with the owner of that .proto file to specify a centralized Go package that a plurality of users can all depend on.</li>
</ul>
</li>
<li><p>Missing or generic proto package names. If a .proto file does not specify a package name or uses an overly generic package name (for example, “my_service”), then there is a high probability that declarations within that file will conflict with other declarations elsewhere in the universe. We recommend that every .proto file have a package name that is deliberately chosen to be universally unique (for example, prefixed with the name of a company).</p>
<ul>
<li>Warning: Retroactively changing the package name on a .proto file can potentially cause the use of extension fields or messages stored in google.protobuf.Any to stop working properly.</li>
</ul>
</li>
</ul>
<p>Starting with <code>v1.26.0</code> of the <code>google.golang.org/protobuf</code> module, a hard error will be reported when a Go program starts up that has multiple conflicting protobuf names linked into it. While it is preferable that the source of the conflict be fixed, the fatal error can be immediately worked around in one of two ways:</p>
<ol>
<li><p>At compile time. The default behavior for handling conflicts can be specified at compile time with a linker-initialized variable: <code>go build -ldflags &quot;-X google.golang.org/protobuf/reflect/protoregistry.conflictPolicy=warn&quot;</code></p>
</li>
<li><p>At program execution. The behavior for handling conflicts when executing a particular Go binary can be set with an environment variable: <code>GOLANG_PROTOBUF_REGISTRATION_CONFLICT=warn ./main</code></p>
</li>
</ol>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>通过上面分析可知，在不同版本的包中处理策略也不同。所以，可以通过设置环境变量、降低版本来解决。</p>
<ol>
<li>设置环境变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译时</span></span><br><span class="line">go build -ldflags &quot;-X google.golang.org/protobuf/reflect/protoregistry.conflictPolicy=warn&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行时</span></span><br><span class="line">GOLANG_PROTOBUF_REGISTRATION_CONFLICT=warn ./main</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>降低版本</li>
</ol>
<p>在 go.mod 中添加 replace 降低包的版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">replace (</span><br><span class="line">	google.golang.org/protobuf =&gt; google.golang.org/protobuf v1.25.0</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>添加之后执行 <code>go mod tidy</code>，然后重新编译、运行。</p>
<p>目前，笔者这里使用的方式2，通过降低版本来解决问题。</p>
<h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><p>关于 protobuf 的 <code>github.com/golang/protobuf</code> 与 <code>google.golang.org/protobuf</code> 区别</p>
<p>The github.com&#x2F;golang&#x2F;protobuf module is the original Go protocol buffer API.</p>
<p>The google.golang.org&#x2F;protobuf module is an updated version of this API designed for simplicity, ease of use, and safety. The flagship features of the updated API are support for reflection and a separation of the user-facing API from the underlying implementation.</p>
<p>We recommend that you use google.golang.org&#x2F;protobuf in new code.</p>
<p>Version v1.4.0 and higher of github.com&#x2F;golang&#x2F;protobuf wrap the new implementation and permit programs to adopt the new API incrementally. For example, the well-known types defined in github.com&#x2F;golang&#x2F;protobuf&#x2F;ptypes are simply aliases of those defined in the newer module. Thus, google.golang.org&#x2F;protobuf&#x2F;types&#x2F;known&#x2F;emptypb and github.com&#x2F;golang&#x2F;protobuf&#x2F;ptypes&#x2F;empty may be used interchangeably.</p>
<p><code>github.com/golang/protobuf</code> 模块是原始的Go协议缓冲区API。<br><code>google.golang.org/protobuf</code> 模块是此API的更新版本，其设计宗旨是简单、易于使用和安全。更新后的API的主要特性是支持反射，并将面向用户的API与底层实现分离。</p>
<p>建议在新代码中使用 <code>google.golang.org/protobuf</code></p>
<p><code>github.com/golang/protobuf</code> 的v1.4.0及更高版本包装了新的实现，并允许程序以增量方式采用新的API。例如，在 <code>github.com/golang/protobuf/ptypes</code> 中定义的知名类型只是在新模块中定义的那些类型的别名。因此，<code>google.golang.org/protobuf/types/known/emptypb</code> 和<code>github.com/golang/protobuf/ptypes/empty</code> 可以互换使用。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/xiaowangzi.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/xiaowangzi.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">ivansli</div><div class="post-copyright__author_desc">学无止境</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.ivansli.com/2022/08/07/grpc-conflict/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.ivansli.com/2022/08/07/grpc-conflict/')">Protobuf Name Conflict 分析与解决</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><!--span.reward-title 感谢你赐予我前进的力量--><ul class="reward-group"><li class="reward-item"><a href="/img/reward/wechat-small.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/wechat-small.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/reward/alipay-small.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/alipay-small.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><!--a.reward-main-btn(href='/about/#about-reward' target='_blank')//.reward-text 赞赏者名单
//.reward-dec 因为你们的支持让我意识到写文章的价值🙏--></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.ivansli.com/2022/08/07/grpc-conflict/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Protobuf Name Conflict 分析与解决&amp;url=https://blog.ivansli.com/2022/08/07/grpc-conflict/&amp;pic=/img/2022/08/1392790189.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本文系原创作品，版权所有（禁止转载）</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/golang/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>golang<span class="tagsPageCount">31</span></a><a class="post-meta__box__tags" href="/tags/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>常见问题<span class="tagsPageCount">6</span></a><a class="post-meta__box__tags" href="/tags/grpc-go/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>grpc-go<span class="tagsPageCount">3</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/img/2024/07/helm.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/16/mqtt-mosquitto/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/07/3164011582.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">初识MQTT与mosquitto</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/04/5-ways-generate-distributed-unique-id/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/10/0001.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">分布式ID的5种生成方式以及Go源码中的一种应用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2021/12/20/grpc-go-ingress/" title="grpc-go请求ingress遇到的一个问题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2021/12/619562057.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-12-20</div><div class="title">grpc-go请求ingress遇到的一个问题</div></div></a></div><div><a href="/2021/12/20/go-leak/" title="一次 goroutine泄露 的排查"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/01/3628718896.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-12-20</div><div class="title">一次 goroutine泄露 的排查</div></div></a></div><div><a href="/2022/02/05/grpc-keepalive/" title="grpc-go设置keepalive"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/space-man-small.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-02-05</div><div class="title">grpc-go设置keepalive</div></div></a></div><div><a href="/2024/07/07/240707-helm/" title="helm的安装&#x2F;使用及其运行原理"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2024/07/helm.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-07-07</div><div class="title">helm的安装&#x2F;使用及其运行原理</div></div></a></div><div><a href="/2022/10/04/5-ways-generate-distributed-unique-id/" title="分布式ID的5种生成方式以及Go源码中的一种应用"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/10/0001.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-10-04</div><div class="title">分布式ID的5种生成方式以及Go源码中的一种应用</div></div></a></div><div><a href="/2021/11/20/algo-python-vietnam-money/" title="数字转越南语词组实现方法"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/space-man-small.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-11-20</div><div class="title">数字转越南语词组实现方法</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/xiaowangzi.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/goutou.png" ait="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这里有<b style="color:#fff">知识总结</b>和<b style="color:#fff">技术分享</b>。书山有路勤为径，学海无涯苦作舟。<b style="color:#fff">此生也有涯</b>，<b style="color:#fff">此生学无涯</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">ivansli</h1><div class="author-info__desc">学无止境</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/coderstart" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">问题背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">分析过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-do-I-fix-a-protocol-buffer-namespace-conflict"><span class="toc-number">2.1.</span> <span class="toc-text">How do I fix a protocol buffer namespace conflict?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">解决办法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86"><span class="toc-number">4.</span> <span class="toc-text">扩展知识</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/07/240707-helm/" title="helm的安装/使用及其运行原理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2024/07/helm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="helm的安装/使用及其运行原理"/></a><div class="content"><a class="title" href="/2024/07/07/240707-helm/" title="helm的安装/使用及其运行原理">helm的安装/使用及其运行原理</a><time datetime="2024-07-07T01:00:00.000Z" title="发表于 2024-07-07 09:00:00">2024-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/11/theroadtoserfdom/" title="读：哈耶克《到奴役之路》有感"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/11/hayeke.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="读：哈耶克《到奴役之路》有感"/></a><div class="content"><a class="title" href="/2023/11/11/theroadtoserfdom/" title="读：哈耶克《到奴役之路》有感">读：哈耶克《到奴役之路》有感</a><time datetime="2023-11-11T01:44:00.000Z" title="发表于 2023-11-11 09:44:00">2023-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/07/231007-game-theory3/" title="二人零和博弈与最大最小定理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/09/gametheory-01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="二人零和博弈与最大最小定理"/></a><div class="content"><a class="title" href="/2023/10/07/231007-game-theory3/" title="二人零和博弈与最大最小定理">二人零和博弈与最大最小定理</a><time datetime="2023-10-07T08:45:00.000Z" title="发表于 2023-10-07 16:45:00">2023-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/07/231007-game-theory2/" title="博弈论对一般问题的建模分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/09/gametheory-01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="博弈论对一般问题的建模分析"/></a><div class="content"><a class="title" href="/2023/10/07/231007-game-theory2/" title="博弈论对一般问题的建模分析">博弈论对一般问题的建模分析</a><time datetime="2023-10-07T03:40:00.000Z" title="发表于 2023-10-07 11:40:00">2023-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/18/230918-game-theory/" title="认识博弈论"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/09/gametheory-01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="认识博弈论"/></a><div class="content"><a class="title" href="/2023/09/18/230918-game-theory/" title="认识博弈论">认识博弈论</a><time datetime="2023-09-18T10:00:00.000Z" title="发表于 2023-09-18 18:00:00">2023-09-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><!-- - let centerImg = theme.footer.socialBar.centerImg ? theme.footer.socialBar.centerImg : theme.avatar.img--><div id="footer_deal"><!-- 左侧图标--><a class="deal_link" href="mailto:gopher001@outlook.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><!--个人头像图标--><!--img.footer_mini_logo(title="返回顶部", alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)", src=centerImg, size="50px")--><!-- 右侧图标--><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/coderstart" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="文章列表" href="/archives/">文章列表</a><a class="footer-item" title="我的书单" href="/booklist/">我的书单</a><a class="footer-item" title="极客说说" href="/essay/">极客说说</a><a class="footer-item" title="关于本站" href="/about/">关于本站</a></div></div><div class="footer-group"><div class="footer-title">分类</div><div class="footer-links"><a class="footer-item" title="编程原理" href="/categories/%E7%BC%96%E7%A8%8B%E5%8E%9F%E7%90%86/">编程原理</a><a class="footer-item" title="系统架构" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a><a class="footer-item" title="中间件" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><a class="footer-item" title="编程原理" href="/categories/%E7%BC%96%E7%A8%8B%E5%8E%9F%E7%90%86/">编程原理</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title">友链</div><div class="footer-links"><a class="footer-item" title="编程导航" target="_blank" rel="noopener" href="https://tool.ivansli.com/">编程导航</a></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" style="margin-inline:5px" data-title="博客框架为Hexo" title="博客框架为Hexo"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo"/></a><a class="github-badge" target="_blank" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/badge/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2019 - 2024 · <a class="footer-bar-link" href="/" title="ivansli" target="_blank">ivansli</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="http://beian.miit.gov.cn" title="沪ICP备2021031949号">沪ICP备2021031949号</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://tool.ivansli.com" title="编程导航">编程导航</a><a class="footer-bar-link cc" href="/" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">80</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">20</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="anzhiyufont anzhiyu-icon-house-chimney faa-tada"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/booklist/"><i class="anzhiyufont anzhiyu-icon-book faa-tada"></i><span> 书单</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada"></i><span> 关于</span></a></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Apple/" style="font-size: 0.88rem;">Apple<sup>2</sup></a><a href="/tags/CI-CD/" style="font-size: 0.88rem;">CI/CD<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">C语言<sup>1</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>2</sup></a><a href="/tags/IoT/" style="font-size: 0.88rem;">IoT<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>2</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>5</sup></a><a href="/tags/PHP/" style="font-size: 0.88rem;">PHP<sup>1</sup></a><a href="/tags/Python/" style="font-size: 0.88rem;">Python<sup>1</sup></a><a href="/tags/Unix/" style="font-size: 0.88rem;">Unix<sup>2</sup></a><a href="/tags/ZooKeeper/" style="font-size: 0.88rem;">ZooKeeper<sup>1</sup></a><a href="/tags/crontab/" style="font-size: 0.88rem;">crontab<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>4</sup></a><a href="/tags/gitlab/" style="font-size: 0.88rem;">gitlab<sup>1</sup></a><a href="/tags/golang/" style="font-size: 0.88rem;">golang<sup>31</sup></a><a href="/tags/grpc-go/" style="font-size: 0.88rem;">grpc-go<sup>3</sup></a><a href="/tags/k8s/" style="font-size: 0.88rem;">k8s<sup>1</sup></a><a href="/tags/redis/" style="font-size: 0.88rem;">redis<sup>6</sup></a><a href="/tags/%E4%B8%AD%E6%96%87%E7%BC%96%E7%A8%8B/" style="font-size: 0.88rem;">中文编程<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">中间件<sup>13</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FID/" style="font-size: 0.88rem;">分布式ID<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 0.88rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%BC%88%E8%AE%BA/" style="font-size: 0.88rem;">博弈论<sup>3</sup></a><a href="/tags/%E5%8F%B7%E6%AE%B5%E5%8F%91%E5%8F%B7%E5%99%A8/" style="font-size: 0.88rem;">号段发号器<sup>1</sup></a><a href="/tags/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" style="font-size: 0.88rem;">常见问题<sup>6</sup></a><a href="/tags/%E6%8C%87%E6%95%B0%E9%80%80%E9%81%BF/" style="font-size: 0.88rem;">指数退避<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem;">数据库<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 0.88rem;">消息队列<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E6%8A%80%E5%B7%A7/" style="font-size: 0.88rem;">算法技巧<sup>6</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">系统架构<sup>5</sup></a><a href="/tags/%E7%BB%8F%E6%B5%8E%E5%AD%A6/" style="font-size: 0.88rem;">经济学<sup>4</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%8E%86%E5%8F%B2/" style="font-size: 0.88rem;">编程历史<sup>8</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">编程原理<sup>31</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">编程工具<sup>1</sup></a><a href="/tags/%E8%81%8C%E5%9C%BA%E5%BF%83%E5%A3%B0/" style="font-size: 0.88rem;">职场心声<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">软件工具<sup>2</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E7%BB%8F%E9%AA%8C/" style="font-size: 0.88rem;">面试经验<sup>4</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/instant.page/instantpage.js" type="module"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/pluginsSrc/node-snackbar/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script async data-pjax src="/pluginsSrc/anzhiyu-theme-static/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="/pluginsSrc/anzhiyu-theme-static/icon/ali_iconfont_css.css"><script defer="defer" id="fluttering_ribbon" mobile="true" src="/pluginsSrc/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="/pluginsSrc/anzhiyu-theme-static/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/anzhiyu-blog-static/js/APlayer.min.js"></script><script src="/pluginsSrc/hexo-anzhiyu-music/assets/js/Meting2.min.js"></script><script src="/pluginsSrc/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="/pluginsSrc/anzhiyu-theme-static/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>