<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç† | æå®¢ä¹‹é“</title><meta name="keywords" content="etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†"><meta name="author" content="ivansli"><meta name="copyright" content="ivansli"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†"><meta name="application-name" content="etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†"><meta property="og:url" content="https://blog.ivansli.com/2021/05/24/etcd-lock/index.html"><meta property="og:site_name" content="æå®¢ä¹‹é“"><meta property="og:description" content="etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://blog.ivansli.com/img/space-man-small.png"><meta property="article:author" content="ivansli"><meta property="article:tag" content="ä¼Šä¸‡çš„å°ç«™,ivansli,ç¼–ç¨‹æŠ€æœ¯,ç¼–ç¨‹æŠ€æœ¯ä¹‹é“,ç¼–ç¨‹åŸç†,goå¼€å‘æŠ€å·§"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.ivansli.com/img/space-man-small.png"><meta name="description" content="etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://blog.ivansli.com/2021/05/24/etcd-lock/"><link rel="preconnect"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: undefined,
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: undefined,
  friends_vue_info: undefined,
  navMusic: false,
  mainTone: undefined,
  authorStatus: {"skills":["ğŸ¤–ï¸ æ•°ç ç§‘æŠ€çˆ±å¥½è€…","ğŸ” åˆ†äº«ä¸çƒ­å¿ƒå¸®åŠ©","ğŸƒ è„šè¸å®åœ°è¡ŒåŠ¨æ´¾"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç®€","rightMenuMsgToTraditionalChinese":"è½¬ä¸ºç¹ä½“","rightMenuMsgToSimplifiedChinese":"è½¬ä¸ºç®€ä½“"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"ä½œè€…: ivansli","link":"é“¾æ¥: ","source":"æ¥æº: æå®¢ä¹‹é“","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚","copySuccess":"å¤åˆ¶æˆåŠŸï¼Œå¤åˆ¶å’Œè½¬è½½è¯·æ ‡æ³¨æœ¬æ–‡åœ°å€"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.min.js',
      css: '/pluginsSrc/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'æå®¢ä¹‹é“',
  title: 'etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†',
  postAI: '',
  pageFillDescription: '1.å…³äºetcd, 2.å®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶ä»¬, 3.etcdåˆ†å¸ƒå¼é”å®ç°åŸç†, 4.etcdåˆ†å¸ƒå¼é”ç¤ºä¾‹ä»£ç , 5.æºç è§£è¯», 6.å°ç»“, 7.æ‰©å±•é˜…è¯»å…³äºå®˜æ–¹æ–‡æ¡£æ°¸è¿œæ˜¯æœ€å¥½çš„å­¦ä¹ èµ„æ–™å®˜æ–¹ä»‹ç»å¦‚æ˜¯è¯´åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨ä½œä¸ºé…ç½®ç®¡ç†æœåŠ¡å‘ç°å’Œåè°ƒåˆ†å¸ƒå¼å·¥ä½œçš„ä¸€è‡´é”®å€¼å­˜å‚¨è®¸å¤šç»„ç»‡ä½¿ç”¨æ¥å®ç°ç”Ÿäº§ç³»ç»Ÿå¦‚å®¹å™¨è°ƒåº¦å™¨æœåŠ¡å‘ç°æœåŠ¡å’Œåˆ†å¸ƒå¼æ•°æ®å­˜å‚¨ä½¿ç”¨çš„å¸¸è§åˆ†å¸ƒå¼æ¨¡å¼åŒ…æ‹¬é€‰ä¸¾åˆ†å¸ƒå¼é”å’Œç›‘è§†æœºå™¨æ´»åŠ¨å®ç°åˆ†å¸ƒå¼é”ä»…æ˜¯ä¼—å¤šåŠŸèƒ½ä¸­çš„ä¸€é¡¹æœåŠ¡æ³¨å†Œä¸å‘ç°åœ¨ä¸­ç”¨çš„åˆ™ä¼šæ›´å¤šå®˜æ–¹ä¹Ÿå¯¹ä¼—å¤šç»„ä»¶è¿›è¡Œäº†å¯¹æ¯”å¦‚ä¸‹æ‰€ç¤ºå®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶ä»¬åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸ç”¨äºå®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶æœ‰ä¸‹é¢é’ˆå¯¹å„è‡ªçš„ç‰¹æ€§è¿›è¡Œå¯¹æ¯”å¤‡æ³¨å¯ç”¨ä¸­çš„å«ä¹‰ä¸ºé›†ç¾¤èŠ‚ç‚¹æ•°çš„ä¸€åŠä¾‹å¦‚é›†ç¾¤èŠ‚ç‚¹æ•°ä¸ºåˆ™ä¸ºåˆ™ä¸ºä¹Ÿå°±æ˜¯è¯´ä¿è¯é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°èŠ‚ç‚¹å¯ç”¨ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºç»„ä»¶å„è‡ªçš„ç‰¹ç‚¹å¯¹äºåˆ†å¸ƒå¼é”æ¥è¯´åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½è‡³å…³é‡è¦çš„ä¸€ç‚¹æ˜¯è¦æ±‚ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹é›†ç¾¤ä¸æ”¯æŒè€Œæ˜¯æ”¯æŒè™½ç„¶å®˜æ–¹ä¹Ÿç»™å‡ºäº†çš„æ–¹æ¡ˆä½†ç”±äºéœ€è¦éƒ¨ç½²å¤šä¸ªå®ä¾‹è¶…è¿‡ä¸€åŠå®ä¾‹æˆåŠŸæ‰è§†ä¸ºæˆåŠŸéƒ¨ç½²ç»´æŠ¤æ¯”è¾ƒå¤æ‚å¯èƒ½è¿˜ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜æ‰€ä»¥åœ¨å¯¹ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜çš„ä¸šåŠ¡åœºæ™¯ä¸‹ç”µå•†é“¶è¡Œæ”¯ä»˜ä¸€èˆ¬é€‰æ‹©ä½¿ç”¨æˆ–è€…å¯¹æ¯”ä¸å¦‚æœè€ƒè™‘æ€§èƒ½å¹¶å‘é‡ç»´æŠ¤æˆæœ¬æ¥çœ‹ç”±äºæ˜¯ç”¨è¯­è¨€å¼€å‘ç›´æ¥ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¹¶ä¸ä¾èµ–å…¶ä»–ä»»ä½•ä¸œè¥¿åˆ™æ›´å…·æœ‰ä¼˜åŠ¿åˆ†å¸ƒå¼é”å®ç°åŸç†å¯¹äºåˆ†å¸ƒå¼é”æ¥è¯´æ“ä½œçš„åŠ¨ä½œåŒ…å«è·å–é”å¤„ç†è¿‡ç¨‹ä¸­éœ€è¦å¦èµ·çº¿ç¨‹åç¨‹å¯¹é”è¿›è¡Œç»­çº¦é˜²æ­¢é”è¢«é‡Šæ”¾æ—¶ä¸šåŠ¡è¿˜æœªå¤„ç†å®Œæˆé‡Šæ”¾é”åˆ†å¸ƒå¼é”ç¤ºä¾‹ä»£ç å®˜æ–¹å·²ç»å¯¹åˆ†å¸ƒå¼é”è¿›è¡Œäº†å°è£…è¿™é‡Œä½¿ç”¨å®˜æ–¹ç¤ºä¾‹æ¥è®²è§£åˆ›å»ºå¯¹è±¡ä¸ºç«¯çš„åœ°å€è¿™é‡Œè¿æ¥åˆ°æœ¬åœ°çš„ç”¨å®Œå…³é—­è¿æ¥é€šè¿‡åˆ›å»ºä¼šè¯æ³¨æ„ä¼šè¯ä¸­åŒ…å«ä¸€ä¸ªç§Ÿçº¦åœ¨åé¢åˆ›å»ºæ—¶ä¸è¿›è¡Œç»‘å®šä»è€Œè¿›è¡Œä¿æ´»å†™æ³•å†™æ³•è¿™é‡Œåªæ˜¯éšä¾¿å†™ä¸€ä¸ªæ•°å€¼å…·ä½“çš„è¿˜éœ€è¦åˆ›å»ºç”¨å®Œå…³é—­åˆ›å»ºé”é”çš„å‰ç¼€ä¸ºåˆ›å»ºä¼šè¯é”é€šè¿‡å–è·å–é”ç­‰äºè¯´æ˜è·å¾—åˆ°äº†é”å› ä¸ºé”è¢«æŒæœ‰äº†æ­¤æ—¶ä¸åº”è¯¥è·å¾—åˆ°é”èµ°åˆ°è¿™é‡Œè¯´æ˜é™¤äº†é—®é¢˜é‡Šæ”¾é”è¯•å›¾å»è·å–é”å› ä¸ºå·²ç»é‡Šæ”¾äº†é”æ‰€ä»¥ä¼šæˆåŠŸè·å–åˆ°é”æºç è§£è¯»é€šè¿‡ç¤ºä¾‹å¯ä»¥çœ‹å‡ºä½¿ç”¨å®ç°åˆ†å¸ƒå¼é”éå¸¸æ–¹ä¾¿è°ƒç”¨çš„æ–¹æ³•ä¸»è¦æœ‰åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ç§Ÿçº¦çš„ä¼šè¯åˆ›å»ºå®ç°é”çš„å¯¹è±¡å¦‚æœé”è¢«å…¶ä»–æŒæœ‰åˆ™ä¼šä¸€ç›´é˜»å¡åˆ°èƒ½è·å–åˆ°é”å¦‚æœé”è¢«å…¶ä»–æŒæœ‰åˆ™ä¸ä¼šé˜»å¡è€Œæ˜¯ç›´æ¥è¿”å›é‡Šæ”¾é”å¯¹ä¼šè¯è§£è¯»é»˜è®¤ç§’ä¼šè¯é€‰é¡¹ç§Ÿçº¦å®¢æˆ·ç«¯å¯¹è±¡é€‰é¡¹ç§Ÿçº¦è¿™é‡Œå…ˆè®¾ç½®ä¸ºé»˜è®¤å€¼å¦‚æœåŒ…å«ç”¨äºè®¾ç½®çš„æ–¹æ³•å°±ä¼šä½¿ç”¨é…ç½®çš„å€¼è¦†ç›–é»˜è®¤å€¼ç§Ÿçº¦å¦‚æœåŒ…å«ç”¨äºè®¾ç½®çš„æ–¹æ³•åˆ™å¤§äºä¸ºå¸¸é‡ä¹Ÿå°±æ˜¯è¯´æœªè®¾ç½®ç§Ÿçº¦åˆ™ä¼šæ ¹æ®åˆ›å»ºç§Ÿçº¦èµ°åˆ°è¿™é‡Œæ—¶ä¸­å·²ç»åŒ…å«äº†ä¸€ä¸ªå¯ç”¨çš„ç§Ÿçº¦å¯¹ä¿æ´»ç›¸å½“äºä¸­è®¾ç½®çš„è¿‡æœŸæ—¶é—´ä¸€æ—¦åˆ°è¾¾è¿‡æœŸæ—¶é—´å°±ä¼šè¢«åˆ é™¤æ˜¯ä¸ºäº†ä¸åœçš„ç»™ç»­çº¦ä»¥é˜²æ­¢ä¸šåŠ¡è¿˜æ²¡å¤„ç†å®Œæˆå°±è¢«é‡Šæ”¾äº†å°è£…çš„åº“ä¸­æœ‰è¿™é‡Œçš„å°±ç›¸å½“äºæ˜¯ä¸€ä¸ªä»è¯»å–å€¼å´ä¸ç”¨æ˜¯å› ä¸ºçš„ç¼“å†²åŒºå¤§å°å›ºå®šå¦åˆ™è¢«å¡«æ»¡ä¹‹åå¯èƒ½ä¼šé€ æˆé˜»å¡ä»è€Œå‡ºç°é—®é¢˜å¯¹é”å¯¹è±¡è§£è¯»å¯¹è±¡åŒ…å«ç§Ÿçº¦éœ€è¦è·Ÿè¿›è¡Œç»‘å®šé”å‰ç¼€æœ€ç»ˆé”çš„å³é”å‰ç¼€ç§Ÿçº¦çš„è¯·æ±‚è·å–é”æ—¶è¿”å›çš„ä¿¡æ¯åˆ›å»ºé”å¯¹è±¡å¯¹åŠ é”æ–¹æ³•çš„è§£è¯»å¾ˆå…³é”®å°è¯•åŠ é”æ ¸å¿ƒæŒæœ‰é”ä¸­çš„å³å½“å‰æ˜¯è°æŒæœ‰çš„è¿™æŠŠé”å¦‚æœè¿˜æ²¡æœ‰æŒæœ‰è¿™æŠŠé”åˆ™å¦‚æœæŒæœ‰é”çš„äººæ˜¯è‡ªå·±åˆ™åªè¦ç¬¦åˆä¸Šé¢ä¸ªæ¡ä»¶å°±è¯´æ˜æ˜¯è‡ªå·±è·å¾—äº†é”è·å¾—äº†é”ç›´æ¥è¿”å›æ²¡æœ‰è·å¾—åˆ°é”éœ€è¦åˆ™é˜»å¡ç­‰å¾…é”çš„é‡Šæ”¾ä¸ºäº†é¿å…æƒŠç¾¤æ•ˆåº”åªç›‘å¬æ¯”è‡ªå·±å°çš„å‰ä¸€ä¸ªè¡¨ç¤ºè‡ªå·±åªå…³å¿ƒæ¯”è‡ªå·±å°çš„è€Œè¿™ä¸ªæœ€å¤§æ˜¯å”¯ä¸€ä¸åŒçš„æ˜¯è¿™é‡Œè°ƒç”¨çš„æ˜¯æ–¹æ³•ä¸ä¼šé˜»å¡å†æ¬¡ç¡®è®¤ä¸€ä¸‹è¿˜æœªè¿‡æœŸå°è¯•å»åŠ é”å®¢æˆ·ç«¯å¯¹è±¡æœ€ç»ˆçš„ä¸ºå‰ç¼€ç§Ÿçº¦åˆ¤æ–­çš„æ˜¯å¦ä¸ºä¸ºåˆ™è¡¨ç¤ºè¿˜ä¸å­˜åœ¨é‡è¦åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ç§Ÿçº¦ä¸è¿›è¡Œç»‘å®šçœ‹åˆ°è¿™é‡Œæ˜¯å³å‰ç¼€è€Œä¸æ˜¯å®Œæ•´çš„è¡¨ç¤ºè·å–æœ€å…ˆåˆ›å»ºçš„å³æœ€å°çš„ä¸ºåˆ¤æ–­æ¡ä»¶ä¸ºåˆ›å»ºä¸ºæŸ¥è¯¢ä¸ºæŸ¥è¯¢æŒæœ‰å‰ç¼€çš„æœ€å°çš„ä¿¡æ¯æ³¨æ„è¿™é‡Œä½¿ç”¨äº†çš„äº‹åŠ¡å†™æ³•è¯­ä¹‰ç±»ä¼¼äºç¼–ç¨‹è¯­è¨€ä¸­çš„ä¼ªä»£ç å¦‚ä¸‹æ‰§è¡Œä¸­åŒ…å«çš„åŠ¨ä½œåŠ¨ä½œå¯ä»¥æ˜¯å¤šä¸ªæ‰§è¡Œä¸­æ‰§è¡Œçš„åŠ¨ä½œåŠ¨ä½œå¯ä»¥æ˜¯å¤šä¸ªä¸€å¥è¯æ¦‚æ‹¬åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸å­˜åœ¨åˆ™æ‰§è¡Œå­˜åœ¨åˆ™æ‰§è¡Œç”±äºéœ€è¦è¯·æ±‚è¿œç«¯çš„æ‰€ä»¥åªæœ‰åœ¨è°ƒç”¨æ—¶æ‰ä¼šå‘èµ·å¯¹è¿œç«¯çš„è°ƒç”¨æ‰§è¡Œä¸Šé¢çš„é€»è¾‘å¦‚æœä¸ºåˆ™ä¸ºå¦åˆ™ä¸ºåˆ™ä¸ºä¸ºäº†æ›´å¥½åœ°è¯´æ˜è·å–é”çš„è¿‡ç¨‹å‡è®¾å­˜åœ¨ä¸ªåˆ†åˆ«åˆ›å»ºå±äºè‡ªå·±çš„ç”±äºæœ€å…ˆåˆ›å»ºæ‰€ä»¥åªæœ‰è·å¾—äº†é”æ­¤æ—¶åªç›‘å¬æ¯”è‡ªå·±å°å¹¶ä¸”è·ç¦»è‡ªå·±æœ€è¿‘çš„çš„åˆ é™¤äº‹ä»¶ä¸€æ—¦åˆ é™¤äº†åˆ™è·å¾—é”åŒç†åªç›‘å¬æ¯”è‡ªå·±å°å¹¶ä¸”è·ç¦»è‡ªå·±æœ€è¿‘çš„çš„åˆ é™¤äº‹ä»¶åˆ é™¤äº†åˆ™è·å¾—é”å¯¹ç›‘å¬åˆ é™¤äº‹ä»¶çš„æ–¹æ³•çš„è§£è¯»æ³¨æ„è¿™é‡Œæ¯”è¾ƒæ ¸å¿ƒæ¯”è‡ªå·±å°å¹¶ä¸”è·ç¦»è‡ªå·±æœ€è¿‘çš„é€šè¿‡ç€ä¸¤ä¸ªæ¡ä»¶æ¥é™åˆ¶è‡ªå·±å…³æ³¨çš„é•¿ä»€ä¹ˆæ ·å­å…³æ³¨çš„çš„æŒ‰ç…§å€’åºæ’åˆ—åªå–ä¸€ä¸ªå…³æ³¨çš„çš„æœ€å¤§ä¸ºå…ˆè·å–å…³æ³¨å¹¶ä¸”å°†è¦çš„çš„ä¿¡æ¯ç›‘å¬çš„å³æ¯”è‡ªå·±å°å¹¶ä¸”è·ç¦»è‡ªå·±æœ€è¿‘çš„ä¸­ç›‘å¬å…³æ³¨çš„æ— äº‹ä»¶å‘ç”Ÿåˆ™ä¸€ç›´é˜»å¡ä¸ºå¯¹åº”çš„çš„å¯¹è¿›è¡Œç›‘å¬ä¸ºçš„æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿä¹‹åéƒ½ä¼šä»ä¸­è·å–çš„åˆ°äº‹ä»¶ä¿¡æ¯åªå…³æ³¨åˆ é™¤äº‹ä»¶æ­£å¸¸æƒ…å†µä¸‹åªæœ‰åˆ é™¤äº‹ä»¶å‘ç”Ÿæ‰ä¼šé€€å‡ºå¯¹åˆ é™¤æ–¹æ³•çš„è§£è¯»è¯·æ±‚å¯¹è¿›è¡Œåˆ é™¤æ“ä½œæŠŠé‡ç½®ä¸ºç å€¼ä¸ºçš„å­—ç¬¦å³å°ç»“å¥½çš„åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡ä¸€ä¸‹å‡ ç‚¹äº’æ–¥æ€§ä»»æ„æ—¶åˆ»åŒä¸€ä¸ªé”åªæœ‰ä¸€ä¸ªæ“ä½œå¯¹è±¡èƒ½æŒæœ‰é€šè¿‡å¯¹çš„ç›¸åŒå‰ç¼€åŠ é”æœ€å°è€…è·å¾—é”å®ç°å®‰å…¨æ€§é¿å…æ­»é”å½“è¿›ç¨‹æ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”è¿›ç¨‹å´©æºƒé€€å‡ºä¿è¯å…¶ä»–è¿›ç¨‹èƒ½å¤ŸåŠ é”é€šè¿‡å¯¹çš„ç›¸åŒå‰ç¼€åŠ é”éæœ€å°è€…åˆ›å»ºå¹¶é˜»å¡ç­‰å¾…å¯ç”¨æ€§å½“æä¾›é”çš„æœåŠ¡èŠ‚ç‚¹æ•…éšœå®•æœºæ—¶çƒ­å¤‡èŠ‚ç‚¹èƒ½å¤Ÿæ¥æ›¿æ•…éšœçš„èŠ‚ç‚¹ç»§ç»­æä¾›æœåŠ¡å¹¶ä¿è¯è‡ªèº«æŒæœ‰çš„æ•°æ®ä¸æ•…éšœèŠ‚ç‚¹ä¸€è‡´é€šè¿‡ä¸€è‡´æ€§ç®—æ³•æ¥ä¿è¯çš„ä¸»ä»é›†ç¾¤æˆ–è€…ç®—æ³•åœ¨è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜å¯¹ç§°æ€§å¯¹åŒä¸€ä¸ªé”åŠ é”å’Œè§£é”å¿…é¡»æ˜¯åŒä¸€ä¸ªè¿›ç¨‹å³æŸè¿›ç¨‹ä¸èƒ½æŠŠå…¶ä»–è¿›ç¨‹æŒæœ‰çš„é”ç»™é‡Šæ”¾äº†æ¯ä¸€ä¸ªåŠ é”å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹è±¡è§£é”æ—¶åˆ é™¤çš„æ˜¯å®Œæ•´çš„åç§°è€Œéå‰ç¼€ä½¿ç”¨å‰ç¼€ä¿è¯äº†çš„å”¯ä¸€æ€§é€šè¿‡æºç è§£è¯»å¯çŸ¥å…·å¤‡ä¸Šè¿°ç‰¹æ€§å¹¶ä¸”æ˜¯ä¸€æŠŠåˆæ ¼çš„åˆ†å¸ƒå¼é”æ‰©å±•é˜…è¯»äº¤äº’ä¸­å«ä¹‰',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-08 15:38:53',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">æå®¢ä¹‹é“</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="anzhiyufont anzhiyu-icon-house-chimney faa-tada"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/booklist/"><i class="anzhiyufont anzhiyu-icon-book faa-tada"></i><span> ä¹¦å•</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada"></i><span> å…³äº</span></a></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="éšæœºå‰å¾€ä¸€ä¸ªæ–‡ç« " href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="åˆ‡æ¢"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">åŸåˆ›</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url">ä¸­é—´ä»¶</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ä¸­é—´ä»¶</span></a></span></div></div><h1 class="post-title" itemprop="name headline">etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2021-05-24T00:29:00.000Z" title="å‘è¡¨äº 2021-05-24 08:29:00">2021-05-24</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-07-08T07:38:53.257Z" title="æ›´æ–°äº 2024-07-08 15:38:53">2024-07-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="æ–‡ç« å­—æ•°"></i><span class="post-meta-label" title="æ–‡ç« å­—æ•°">å­—æ•°æ€»è®¡:</span><span class="word-count" title="æ–‡ç« å­—æ•°">3.7k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="é˜…è¯»æ—¶é•¿"></i><span class="post-meta-label" title="é˜…è¯»æ—¶é•¿">é˜…è¯»æ—¶é•¿:</span><span>16åˆ†é’Ÿ</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="é˜…è¯»é‡">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="ä½œè€…IPå±åœ°ä¸ºä¸Šæµ·"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>ä¸Šæµ·</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/img/space-man-small.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.ivansli.com/2021/05/24/etcd-lock/"><header><a class="post-meta-categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url">ä¸­é—´ä»¶</a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" tabindex="-1" itemprop="url">ä¸­é—´ä»¶</a><h1 id="CrawlerTitle" itemprop="name headline">etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">ivansli</span><time itemprop="dateCreated datePublished" datetime="2021-05-24T00:29:00.000Z" title="å‘è¡¨äº 2021-05-24 08:29:00">2021-05-24</time><time itemprop="dateCreated datePublished" datetime="2024-07-08T07:38:53.257Z" title="æ›´æ–°äº 2024-07-08 15:38:53">2024-07-08</time></header><h2 id="1-å…³äºetcd"><a href="#1-å…³äºetcd" class="headerlink" title="1.å…³äºetcd"></a>1.å…³äºetcd</h2><p>å®˜æ–¹æ–‡æ¡£æ°¸è¿œæ˜¯æœ€å¥½çš„å­¦ä¹ èµ„æ–™ï¼Œå®˜æ–¹ä»‹ç»etcdå¦‚æ˜¯è¯´ã€‚<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/07/2128363047.png"></p>
<blockquote>
<p>åˆ†å¸ƒå¼ç³»ç»Ÿä½¿ç”¨etcdä½œä¸ºé…ç½®ç®¡ç†ã€æœåŠ¡å‘ç°å’Œåè°ƒåˆ†å¸ƒå¼å·¥ä½œçš„ä¸€è‡´é”®å€¼å­˜å‚¨ã€‚è®¸å¤šç»„ç»‡ä½¿ç”¨etcdæ¥å®ç°ç”Ÿäº§ç³»ç»Ÿï¼Œå¦‚å®¹å™¨è°ƒåº¦å™¨ã€æœåŠ¡å‘ç°æœåŠ¡å’Œåˆ†å¸ƒå¼æ•°æ®å­˜å‚¨ã€‚ä½¿ç”¨etcdçš„å¸¸è§åˆ†å¸ƒå¼æ¨¡å¼åŒ…æ‹¬leaderé€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œç›‘è§†æœºå™¨æ´»åŠ¨ã€‚</p>
</blockquote>
<blockquote>
<p>Distributed systems use etcd as a consistent key-value store for configuration management, service discovery, and coordinating distributed work. Many organizations use etcd to implement production systems such as container schedulers, service discovery services, and distributed data storage. Common distributed patterns using etcd include leader election, distributed locks, and monitoring machine liveness.</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://etcd.io/docs/v3.4/learning/why/">https://etcd.io/docs/v3.4/learning/why/</a></p>
</blockquote>
<p>å®ç°åˆ†å¸ƒå¼é”ä»…æ˜¯ etcd ä¼—å¤šåŠŸèƒ½ä¸­çš„ä¸€é¡¹ï¼ŒæœåŠ¡æ³¨å†Œä¸å‘ç°åœ¨ etcd ä¸­ç”¨çš„åˆ™ä¼šæ›´å¤šã€‚</p>
<p>å®˜æ–¹ä¹Ÿå¯¹ä¼—å¤šç»„ä»¶è¿›è¡Œäº†å¯¹æ¯”ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/07/1157747113.png">


<h2 id="2-å®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶ä»¬"><a href="#2-å®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶ä»¬" class="headerlink" title="2.å®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶ä»¬"></a>2.å®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶ä»¬</h2><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¸¸ç”¨äºå®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶æœ‰ï¼šRedisã€zookeeperã€etcdï¼Œä¸‹é¢é’ˆå¯¹å„è‡ªçš„ç‰¹æ€§è¿›è¡Œå¯¹æ¯”ï¼š<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/07/2994759155.png"></p>
<blockquote>
<p>å¤‡æ³¨ï¼š<code>N+1å¯ç”¨</code> ä¸­çš„ <code>N</code> å«ä¹‰ä¸º <code>é›†ç¾¤èŠ‚ç‚¹æ•°çš„ä¸€åŠ</code><br>ä¾‹å¦‚ï¼Œetcdé›†ç¾¤èŠ‚ç‚¹æ•°ä¸º5ï¼Œåˆ™ N ä¸º 5&#x2F;2&#x3D;2ï¼Œåˆ™ <code>N+1</code> ä¸º3ï¼Œä¹Ÿå°±æ˜¯è¯´ä¿è¯é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°èŠ‚ç‚¹å¯ç”¨ã€‚</p>
</blockquote>
<p>ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºç»„ä»¶å„è‡ªçš„ç‰¹ç‚¹ï¼Œå¯¹äºåˆ†å¸ƒå¼é”æ¥è¯´åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½è‡³å…³é‡è¦çš„ä¸€ç‚¹æ˜¯è¦æ±‚CPã€‚ä½†æ˜¯ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Redisé›†ç¾¤ä¸æ”¯æŒCPï¼Œè€Œæ˜¯æ”¯æŒAPã€‚è™½ç„¶ï¼Œå®˜æ–¹ä¹Ÿç»™å‡ºäº†redlockçš„æ–¹æ¡ˆï¼Œä½†ç”±äºéœ€è¦éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼ˆè¶…è¿‡ä¸€åŠå®ä¾‹æˆåŠŸæ‰è§†ä¸ºæˆåŠŸï¼‰ï¼Œéƒ¨ç½²ã€ç»´æŠ¤æ¯”è¾ƒå¤æ‚ã€å¯èƒ½è¿˜ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚æ‰€ä»¥åœ¨å¯¹ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼ˆç”µå•†ã€é“¶è¡Œæ”¯ä»˜ï¼‰ï¼Œä¸€èˆ¬é€‰æ‹©ä½¿ç”¨zookeeperæˆ–è€…etcdã€‚å¯¹æ¯”zookeeperä¸etcdï¼Œå¦‚æœè€ƒè™‘æ€§èƒ½ã€å¹¶å‘é‡ã€ç»´æŠ¤æˆæœ¬æ¥çœ‹ã€‚ç”±äºetcdæ˜¯ç”¨Goè¯­è¨€å¼€å‘ï¼Œç›´æ¥ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¸ä¾èµ–å…¶ä»–ä»»ä½•ä¸œè¥¿ï¼Œåˆ™æ›´å…·æœ‰ä¼˜åŠ¿ã€‚</p>
<h2 id="3-etcdåˆ†å¸ƒå¼é”å®ç°åŸç†"><a href="#3-etcdåˆ†å¸ƒå¼é”å®ç°åŸç†" class="headerlink" title="3.etcdåˆ†å¸ƒå¼é”å®ç°åŸç†"></a>3.etcdåˆ†å¸ƒå¼é”å®ç°åŸç†</h2><p>å¯¹äºåˆ†å¸ƒå¼é”æ¥è¯´ï¼Œæ“ä½œçš„åŠ¨ä½œåŒ…å«ï¼š<br>1.è·å–é”</p>
<blockquote>
<p>å¤„ç†è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¦èµ·çº¿ç¨‹&#x2F;åç¨‹å¯¹é”è¿›è¡Œç»­çº¦ï¼Œé˜²æ­¢é”è¢«é‡Šæ”¾æ—¶ä¸šåŠ¡è¿˜æœªå¤„ç†å®Œæˆã€‚</p>
</blockquote>
<p>2.é‡Šæ”¾é”</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/07/606101614.png">


<h2 id="4-etcdåˆ†å¸ƒå¼é”ç¤ºä¾‹ä»£ç "><a href="#4-etcdåˆ†å¸ƒå¼é”ç¤ºä¾‹ä»£ç " class="headerlink" title="4.etcdåˆ†å¸ƒå¼é”ç¤ºä¾‹ä»£ç "></a>4.etcdåˆ†å¸ƒå¼é”ç¤ºä¾‹ä»£ç </h2><p>å®˜æ–¹å·²ç»å¯¹ etcd åˆ†å¸ƒå¼é”è¿›è¡Œäº†å°è£…ï¼Œè¿™é‡Œä½¿ç”¨å®˜æ–¹ç¤ºä¾‹æ¥è®²è§£ã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/blob/main/tests/integration/clientv3/concurrency/example_mutex_test.go">https://github.com/etcd-io/etcd/blob/main/tests/integration/clientv3/concurrency/example_mutex_test.go</a></p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;go.etcd.io/etcd/client/v3&quot;</span></span><br><span class="line">	<span class="string">&quot;go.etcd.io/etcd/client/v3/concurrency&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMutex_TryLock</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="comment">// åˆ›å»º etcd client å¯¹è±¡</span></span><br><span class="line">	<span class="comment">// Endpoints ä¸º etcd server ç«¯çš„åœ°å€ï¼Œè¿™é‡Œè¿æ¥åˆ°æœ¬åœ°çš„ etcd server</span></span><br><span class="line">	cli, err := clientv3.New(clientv3.Config&#123;Endpoints: []<span class="type">string</span>&#123;<span class="string">&quot;127.0.0.1:2379&quot;</span>&#125;&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ç”¨å®Œå…³é—­è¿æ¥</span></span><br><span class="line">	<span class="keyword">defer</span> cli.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// create two separate sessions for lock competition</span></span><br><span class="line">	<span class="comment">// é€šè¿‡ etcd client åˆ›å»º session ä¼šè¯</span></span><br><span class="line">	<span class="comment">// æ³¨æ„ï¼šsession ä¼šè¯ä¸­åŒ…å«ä¸€ä¸ªç§Ÿçº¦ï¼Œåœ¨åé¢åˆ›å»º etcd key æ—¶ï¼Œä¸ key è¿›è¡Œç»‘å®šï¼Œä»è€Œè¿›è¡Œä¿æ´»</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// å†™æ³•1</span></span><br><span class="line">	<span class="comment">//s1, err := concurrency.NewSession(cli, concurrency.WithTTL(10))</span></span><br><span class="line">	<span class="comment">// </span></span><br><span class="line">	<span class="comment">// å†™æ³•2</span></span><br><span class="line">	<span class="comment">//leaseId:=100 // è¿™é‡Œåªæ˜¯éšä¾¿å†™ä¸€ä¸ªæ•°å€¼ï¼Œå…·ä½“çš„è¿˜éœ€è¦åˆ›å»º</span></span><br><span class="line">	<span class="comment">//s1, err :=concurrency.NewSession(cli,concurrency.WithLease(clientv3.LeaseID(leaseId)))</span></span><br><span class="line"></span><br><span class="line">	s1, err := concurrency.NewSession(cli)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ç”¨å®Œå…³é—­</span></span><br><span class="line">	<span class="keyword">defer</span> s1.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ›å»º é”1ï¼Œé”çš„ key å‰ç¼€ä¸º /my-lock</span></span><br><span class="line">	m1 := concurrency.NewMutex(s1, <span class="string">&quot;/my-lock&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ›å»ºä¼šè¯2</span></span><br><span class="line">	s2, err := concurrency.NewSession(cli)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> s2.Close()</span><br><span class="line">	<span class="comment">// é”2</span></span><br><span class="line">	m2 := concurrency.NewMutex(s2, <span class="string">&quot;/my-lock&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// acquire lock for s1</span></span><br><span class="line">	<span class="comment">// é€šè¿‡ m1 å–è·å–é”</span></span><br><span class="line">	<span class="comment">// err ç­‰äº nil è¯´æ˜è·å¾—åˆ°äº† é”</span></span><br><span class="line">	<span class="keyword">if</span> err = m1.Lock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;acquired lock for s1&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err = m2.Lock(context.TODO()); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// å› ä¸ºï¼Œé”è¢« m1 æŒæœ‰äº†ï¼Œæ­¤æ—¶ m2 ä¸åº”è¯¥è·å¾—åˆ°é”ï¼Œèµ°åˆ°è¿™é‡Œè¯´æ˜é™¤äº†é—®é¢˜</span></span><br><span class="line">		log.Fatal(<span class="string">&quot;should not acquire lock&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err == concurrency.ErrLocked &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;cannot acquire lock for s2, as already locked in another session&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// m1 é‡Šæ”¾é”</span></span><br><span class="line">	<span class="keyword">if</span> err = m1.Unlock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;released lock for s1&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// m2 è¯•å›¾å»è·å–é”</span></span><br><span class="line">	<span class="comment">// å› ä¸º m1 å·²ç»é‡Šæ”¾äº†é”ï¼Œæ‰€ä»¥ m2 ä¼šæˆåŠŸè·å–åˆ°é”</span></span><br><span class="line">	<span class="keyword">if</span> err = m2.TryLock(context.TODO()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;acquired lock for s2&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Output:</span></span><br><span class="line">	<span class="comment">// acquired lock for s1</span></span><br><span class="line">	<span class="comment">// cannot acquire lock for s2, as already locked in another session</span></span><br><span class="line">	<span class="comment">// released lock for s1</span></span><br><span class="line">	<span class="comment">// acquired lock for s2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-æºç è§£è¯»"><a href="#5-æºç è§£è¯»" class="headerlink" title="5.æºç è§£è¯»"></a>5.æºç è§£è¯»</h2><p>é€šè¿‡ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ etcd å®ç°åˆ†å¸ƒå¼é”éå¸¸æ–¹ä¾¿ï¼Œè°ƒç”¨çš„æ–¹æ³•ä¸»è¦æœ‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// NewSession gets the leased session for a client.</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª å¸¦æœ‰ç§Ÿçº¦ çš„ä¼šè¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSession</span><span class="params">(client *v3.Client, opts ...SessionOption)</span></span> (*Session, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º å®ç°é”çš„ å¯¹è±¡ Mutex</span></span><br><span class="line"><span class="comment">// Mutex implements the sync Locker interface with etcd</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMutex</span><span class="params">(s *Session, pfx <span class="type">string</span>)</span></span> *Mutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lock locks the mutex with a cancelable context. If the context is canceled</span></span><br><span class="line"><span class="comment">// while trying to acquire the lock, the mutex tries to clean its stale lock entry.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¦‚æœé”è¢«å…¶ä»– session æŒæœ‰ï¼Œåˆ™ä¼šä¸€ç›´é˜»å¡åˆ°èƒ½è·å–åˆ°é”</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Lock(ctx context.Context) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TryLock locks the mutex if not already locked by another session.</span></span><br><span class="line"><span class="comment">// If lock is held by another session, return immediately after attempting necessary cleanup</span></span><br><span class="line"><span class="comment">// The ctx argument is used for the sending/receiving Txn RPC.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¦‚æœé”è¢«å…¶ä»– session æŒæœ‰ï¼Œåˆ™ä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> TryLock(ctx context.Context) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Unlock(ctx context.Context) <span class="type">error</span></span><br></pre></td></tr></table></figure>


<p>å¯¹ä¼šè¯ Session è§£è¯»ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// session ttl é»˜è®¤ 60ç§’</span></span><br><span class="line"><span class="keyword">const</span> defaultSessionTTL = <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// session ä¼šè¯é€‰é¡¹</span></span><br><span class="line"><span class="keyword">type</span> sessionOptions <span class="keyword">struct</span> &#123;</span><br><span class="line">	ttl     <span class="type">int</span> <span class="comment">// time to live</span></span><br><span class="line">	leaseID v3.LeaseID <span class="comment">// ç§Ÿçº¦id</span></span><br><span class="line"></span><br><span class="line">	ctx     context.Context</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Session represents a lease kept alive for the lifetime of a client.</span></span><br><span class="line"><span class="comment">// Fault-tolerant applications may use sessions to reason about liveness.</span></span><br><span class="line"><span class="keyword">type</span> Session <span class="keyword">struct</span> &#123;</span><br><span class="line">	client *v3.Client <span class="comment">// etcd å®¢æˆ·ç«¯å¯¹è±¡</span></span><br><span class="line">	opts   *sessionOptions <span class="comment">// session é€‰é¡¹</span></span><br><span class="line">	id     v3.LeaseID <span class="comment">// ç§Ÿçº¦id</span></span><br><span class="line"></span><br><span class="line">	cancel context.CancelFunc</span><br><span class="line">	donec  &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewSession gets the leased session for a client.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSession</span><span class="params">(client *v3.Client, opts ...SessionOption)</span></span> (*Session, <span class="type">error</span>) &#123;</span><br><span class="line">  <span class="comment">// è¿™é‡Œå…ˆè®¾ç½® session ttl ä¸ºé»˜è®¤å€¼</span></span><br><span class="line">  <span class="comment">// å¦‚æœ opts åŒ…å«ç”¨äºè®¾ç½® ttl çš„æ–¹æ³• `func WithTTL(ttl int) SessionOption` å°±ä¼šä½¿ç”¨é…ç½®çš„å€¼è¦†ç›–é»˜è®¤å€¼</span></span><br><span class="line">	ops := &amp;sessionOptions&#123;ttl: defaultSessionTTL, ctx: client.Ctx()&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		opt(ops)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç§Ÿçº¦id</span></span><br><span class="line">  <span class="comment">// å¦‚æœ opts åŒ…å«ç”¨äºè®¾ç½® ttl çš„æ–¹æ³• `func WithLease(leaseID v3.LeaseID) SessionOption` åˆ™ ops.leaseID å¤§äº 0</span></span><br><span class="line">	id := ops.leaseID</span><br><span class="line">  <span class="comment">// v3.NoLease ä¸º å¸¸é‡0ã€‚ä¹Ÿå°±æ˜¯è¯´æœªè®¾ç½® ç§Ÿçº¦ï¼Œåˆ™ä¼šæ ¹æ® ttl åˆ›å»ºç§Ÿçº¦</span></span><br><span class="line">	<span class="keyword">if</span> id == v3.NoLease &#123;</span><br><span class="line">		resp, err := client.Grant(ops.ctx, <span class="type">int64</span>(ops.ttl))</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		id = resp.ID</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// èµ°åˆ°è¿™é‡Œæ—¶ï¼Œsession ä¸­å·²ç»åŒ…å«äº†ä¸€ä¸ªå¯ç”¨çš„ç§Ÿçº¦</span></span><br><span class="line"></span><br><span class="line">	ctx, cancel := context.WithCancel(ops.ctx)</span><br><span class="line">  <span class="comment">// å¯¹ leaseID ä¿æ´»</span></span><br><span class="line">  <span class="comment">// lease ç›¸å½“äº redis ä¸­è®¾ç½®çš„è¿‡æœŸæ—¶é—´ã€‚ä¸€æ—¦åˆ°è¾¾è¿‡æœŸæ—¶é—´ï¼Œkeyå°±ä¼šè¢«åˆ é™¤</span></span><br><span class="line">  <span class="comment">// KeepAlive() æ˜¯ä¸ºäº† ä¸åœçš„ç»™ key ç»­çº¦ï¼Œä»¥é˜²æ­¢ ä¸šåŠ¡è¿˜æ²¡å¤„ç†å®Œæˆï¼Œkeyå°±è¢«é‡Šæ”¾äº†</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// java å°è£…çš„ redis åº“ä¸­æœ‰ watchdogï¼Œè¿™é‡Œçš„ KeepAlive() å°±ç›¸å½“äº watchdog</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// keepAlive æ˜¯ä¸€ä¸ª chan</span></span><br><span class="line">	keepAlive, err := client.KeepAlive(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || keepAlive == <span class="literal">nil</span> &#123;</span><br><span class="line">		cancel()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	donec := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	s := &amp;Session&#123;client: client, opts: ops, id: id, cancel: cancel, donec: donec&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// keep the lease alive until client error or cancelled context</span></span><br><span class="line">  <span class="comment">// ä» keepAlive è¯»å–å€¼ï¼Œå´ä¸ç”¨æ˜¯å› ä¸º keepAlive çš„ç¼“å†²åŒºå¤§å°å›ºå®šï¼Œå¦åˆ™è¢«å¡«æ»¡ä¹‹åå¯èƒ½ä¼šé€ æˆé˜»å¡ï¼Œä»è€Œå‡ºç°é—®é¢˜</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(donec)</span><br><span class="line">		<span class="keyword">for</span> <span class="keyword">range</span> keepAlive &#123;</span><br><span class="line">			<span class="comment">// eat messages until keep alive channel closes</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹é”å¯¹è±¡ Mutex è§£è¯»ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</span><br><span class="line">	s *Session <span class="comment">// session å¯¹è±¡ï¼ŒåŒ…å«ç§Ÿçº¦idï¼Œéœ€è¦è·Ÿ mykey è¿›è¡Œç»‘å®š</span></span><br><span class="line"></span><br><span class="line">	pfx   <span class="type">string</span> <span class="comment">// é”å‰ç¼€</span></span><br><span class="line">	myKey <span class="type">string</span> <span class="comment">// æœ€ç»ˆé”çš„ key = pfx+s.idï¼Œå³ï¼šé”å‰ç¼€+ç§Ÿçº¦id</span></span><br><span class="line">	myRev <span class="type">int64</span>  <span class="comment">// key çš„ Revision</span></span><br><span class="line"></span><br><span class="line">	hdr   *pb.ResponseHeader <span class="comment">// è¯·æ±‚ etcd server è·å–é”æ—¶ï¼Œè¿”å›çš„ header ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMutex</span><span class="params">(s *Session, pfx <span class="type">string</span>)</span></span> *Mutex &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Mutex&#123;s, pfx + <span class="string">&quot;/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">-1</span>, <span class="literal">nil</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹åŠ é”æ–¹æ³• Lock çš„è§£è¯» (å¾ˆå…³é”®)ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lock locks the mutex with a cancelable context. If the context is canceled</span></span><br><span class="line"><span class="comment">// while trying to acquire the lock, the mutex tries to clean its stale lock entry.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Lock(ctx context.Context) <span class="type">error</span> &#123;</span><br><span class="line">  <span class="comment">// å°è¯•åŠ é”ï¼ˆæ ¸å¿ƒï¼‰</span></span><br><span class="line">	resp, err := m.tryAcquire(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if no key on prefix / the minimum rev is key, already hold the lock</span></span><br><span class="line">  <span class="comment">// æŒæœ‰é” session ä¸­ pfx çš„ kvsï¼Œå³ï¼šå½“å‰æ˜¯è°æŒæœ‰çš„è¿™æŠŠé”</span></span><br><span class="line">	ownerKey := resp.Responses[<span class="number">1</span>].GetResponseRange().Kvs</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// â‘  å¦‚æœè¿˜æ²¡æœ‰æŒæœ‰è¿™æŠŠé”ï¼Œåˆ™ len(ownerKey) == 0</span></span><br><span class="line">  <span class="comment">// â‘¡ å¦‚æœæŒæœ‰é”çš„äººæ˜¯è‡ªå·±ï¼Œåˆ™ ownerKey[0].CreateRevision == m.myRev</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// åªè¦ç¬¦åˆä¸Šé¢2ä¸ªæ¡ä»¶ï¼Œå°±è¯´æ˜æ˜¯è‡ªå·±è·å¾—äº†é”</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ownerKey) == <span class="number">0</span> || ownerKey[<span class="number">0</span>].CreateRevision == m.myRev &#123;</span><br><span class="line">		m.hdr = resp.Header</span><br><span class="line">    <span class="comment">// è·å¾—äº†é”ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	client := m.s.Client()</span><br><span class="line">	<span class="comment">// wait for deletion revisions prior to myKey</span></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> early termination if the session key is deleted before other session keys with smaller revisions.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ²¡æœ‰è·å¾—åˆ°é”ï¼Œéœ€è¦åˆ™é˜»å¡ç­‰å¾…é”çš„é‡Šæ”¾</span></span><br><span class="line">  <span class="comment">// ä¸ºäº†é¿å…æƒŠç¾¤æ•ˆåº”ï¼Œåªç›‘å¬æ¯”è‡ªå·±å°çš„å‰ä¸€ä¸ª key </span></span><br><span class="line">  <span class="comment">// m.myRev-1 è¡¨ç¤ºè‡ªå·±åªå…³å¿ƒæ¯”è‡ªå·±å°çš„ Revisionï¼Œè€Œè¿™ä¸ª Revision æœ€å¤§æ˜¯ m.myRev-1</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// TryLock() å”¯ä¸€ä¸åŒçš„æ˜¯è¿™é‡Œè°ƒç”¨çš„æ˜¯ client.Delete() æ–¹æ³•ã€‚ä¸ä¼šé˜»å¡</span></span><br><span class="line">  _, werr := waitDeletes(ctx, client, m.pfx, m.myRev<span class="number">-1</span>)</span><br><span class="line">	<span class="comment">// release lock key if wait failed</span></span><br><span class="line">	<span class="keyword">if</span> werr != <span class="literal">nil</span> &#123;</span><br><span class="line">		m.Unlock(client.Ctx())</span><br><span class="line">		<span class="keyword">return</span> werr</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// make sure the session is not expired, and the owner key still exists.</span></span><br><span class="line">  <span class="comment">// å†æ¬¡ç¡®è®¤ä¸€ä¸‹ session è¿˜æœªè¿‡æœŸ</span></span><br><span class="line">	gresp, werr := client.Get(ctx, m.myKey)</span><br><span class="line">	<span class="keyword">if</span> werr != <span class="literal">nil</span> &#123;</span><br><span class="line">		m.Unlock(client.Ctx())</span><br><span class="line">		<span class="keyword">return</span> werr</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(gresp.Kvs) == <span class="number">0</span> &#123; <span class="comment">// is the session key lost?</span></span><br><span class="line">		<span class="keyword">return</span> ErrSessionExpired</span><br><span class="line">	&#125;</span><br><span class="line">	m.hdr = gresp.Header</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è¯•å»åŠ é”</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> tryAcquire(ctx context.Context) (*v3.TxnResponse, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// session</span></span><br><span class="line">  s := m.s</span><br><span class="line">  <span class="comment">// etcd å®¢æˆ·ç«¯å¯¹è±¡</span></span><br><span class="line">	client := m.s.Client()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æœ€ç»ˆçš„key ä¸º keyå‰ç¼€+ç§Ÿçº¦id</span></span><br><span class="line">	m.myKey = fmt.Sprintf(<span class="string">&quot;%s%x&quot;</span>, m.pfx, s.Lease())</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ¤æ–­ m.myKey çš„ create_visonæ˜¯å¦ä¸º0</span></span><br><span class="line">  <span class="comment">// ä¸º 0, åˆ™è¡¨ç¤º m.myKey è¿˜ä¸å­˜åœ¨</span></span><br><span class="line">	cmp := v3.Compare(v3.CreateRevision(m.myKey), <span class="string">&quot;=&quot;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// put self in lock waiters via myKey; oldest waiter holds lock</span></span><br><span class="line">  <span class="comment">// ï¼ˆé‡è¦ï¼‰åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ° ç§Ÿçº¦id ä¸ m.myKey è¿›è¡Œç»‘å®š</span></span><br><span class="line">	put := v3.OpPut(m.myKey, <span class="string">&quot;&quot;</span>, v3.WithLease(s.Lease()))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// reuse key in case this session already holds the lock</span></span><br><span class="line">	get := v3.OpGet(m.myKey)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// fetch current holder to complete uncontended path with only one RPC</span></span><br><span class="line">  <span class="comment">// çœ‹åˆ°è¿™é‡Œæ˜¯ m.pfxï¼Œå³ï¼škeyå‰ç¼€ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„key</span></span><br><span class="line">  <span class="comment">// v3.WithFirstCreate() è¡¨ç¤ºè·å–æœ€å…ˆåˆ›å»ºçš„ï¼Œå³ï¼šRevisionæœ€å°çš„</span></span><br><span class="line">	getOwner := v3.OpGet(m.pfx, v3.WithFirstCreate()...)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// cmp ä¸ºåˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">  <span class="comment">// put ä¸ºåˆ›å»º key</span></span><br><span class="line">  <span class="comment">// get ä¸ºæŸ¥è¯¢ key</span></span><br><span class="line">  <span class="comment">// getOwner ä¸ºæŸ¥è¯¢æŒæœ‰keyå‰ç¼€ m.pfx çš„æœ€å°çš„ Revision ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† etcd çš„ äº‹åŠ¡å†™æ³•</span></span><br><span class="line">  <span class="comment">// If(cmp).Then().Else().Commit() è¯­ä¹‰ç±»ä¼¼äºç¼–ç¨‹è¯­è¨€ä¸­çš„ if ... else ...ï¼Œä¼ªä»£ç å¦‚ä¸‹</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// if (cmp) &#123;</span></span><br><span class="line">  <span class="comment">//   //æ‰§è¡Œ then ä¸­åŒ…å«çš„åŠ¨ä½œï¼ˆåŠ¨ä½œå¯ä»¥æ˜¯å¤šä¸ªï¼‰</span></span><br><span class="line">  <span class="comment">//   Then()</span></span><br><span class="line">  <span class="comment">// &#125;else&#123;</span></span><br><span class="line">  <span class="comment">//   //æ‰§è¡Œ else ä¸­æ‰§è¡Œçš„åŠ¨ä½œï¼ˆåŠ¨ä½œå¯ä»¥æ˜¯å¤šä¸ªï¼‰</span></span><br><span class="line">  <span class="comment">//   Else()</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// ä¸€å¥è¯æ¦‚æ‹¬ï¼šåˆ¤æ–­ m.myKey æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ‰§è¡Œ Then()ï¼Œå­˜åœ¨åˆ™æ‰§è¡Œ Else()ã€‚</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ç”±äºéœ€è¦è¯·æ±‚è¿œç«¯çš„ etcd serverï¼Œæ‰€ä»¥åªæœ‰åœ¨ è°ƒç”¨ Commit() æ—¶ï¼Œæ‰ä¼šå‘èµ·å¯¹è¿œç«¯çš„è°ƒç”¨æ‰§è¡Œä¸Šé¢çš„é€»è¾‘</span></span><br><span class="line">	resp, err := client.Txn(ctx).If(cmp).Then(put, getOwner).Else(get, getOwner).Commit()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	m.myRev = resp.Header.Revision</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœ cmp ä¸º trueï¼Œåˆ™ resp.Succeeded  ä¸ºtrue</span></span><br><span class="line">  <span class="comment">// å¦åˆ™ cmp ä¸º falseï¼Œåˆ™ resp.Succeeded ä¸ºfalse</span></span><br><span class="line">	<span class="keyword">if</span> !resp.Succeeded &#123;</span><br><span class="line">		m.myRev = resp.Responses[<span class="number">0</span>].GetResponseRange().Kvs[<span class="number">0</span>].CreateRevision</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ›´å¥½åœ°è¯´æ˜è·å–é”çš„è¿‡ç¨‹ï¼Œå‡è®¾å­˜åœ¨3ä¸ªclientï¼ˆclient1ã€client2ã€client3ï¼‰åˆ†åˆ«åˆ›å»ºå±äºè‡ªå·±çš„key <code>/my-lock/uuid1</code>ã€<code>/my-lock/uuid2</code>ã€<code>/my-lock/uuid3</code>ï¼Œç”±äºclient1æœ€å…ˆåˆ›å»ºï¼Œæ‰€ä»¥åªæœ‰ client1è·å¾—äº†é”ã€‚<br>æ­¤æ—¶ï¼Œclient2 åªç›‘å¬æ¯”è‡ªå·±Revisionå°å¹¶ä¸”è·ç¦»è‡ªå·±Revisionæœ€è¿‘çš„key <code>/my-lock/uuid1</code> çš„åˆ é™¤äº‹ä»¶ï¼Œä¸€æ—¦ client1 åˆ é™¤äº† <code>/my-lock/uuid1</code>ï¼Œåˆ™ client2è·å¾—é”ã€‚<br>åŒç†ï¼Œclient3 åªç›‘å¬æ¯”è‡ªå·±Revisionå°å¹¶ä¸”è·ç¦»è‡ªå·±Revisionæœ€è¿‘çš„key <code>/my-lock/uuid2</code> çš„åˆ é™¤äº‹ä»¶ï¼Œclient2 åˆ é™¤äº† <code>/my-lock/uuid2</code>ï¼Œåˆ™ client3è·å¾—é”ã€‚</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/07/352142567.png">


<p>å¯¹ç›‘å¬keyåˆ é™¤äº‹ä»¶çš„ waitDeletes() æ–¹æ³•çš„è§£è¯»ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// waitDeletes efficiently waits until all keys matching the prefix and no greater</span></span><br><span class="line"><span class="comment">// than the create revision.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">waitDeletes</span><span class="params">(ctx context.Context, client *v3.Client, pfx <span class="type">string</span>, maxCreateRev <span class="type">int64</span>)</span></span> (*pb.ResponseHeader, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// æ³¨æ„ï¼šè¿™é‡Œæ¯”è¾ƒæ ¸å¿ƒï¼Œæ¯”è‡ªå·±Revisionå°å¹¶ä¸”è·ç¦»è‡ªå·±Revisionæœ€è¿‘çš„key</span></span><br><span class="line">  <span class="comment">// é€šè¿‡ v3.WithLastCreate()ã€v3.WithMaxCreateRev(maxCreateRev) ç€ä¸¤ä¸ªæ¡ä»¶æ¥é™åˆ¶è‡ªå·±å…³æ³¨çš„keyé•¿ä»€ä¹ˆæ ·å­</span></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="comment">// v3.WithLastCreate() å…³æ³¨çš„keyçš„ æŒ‰ç…§ CreateRevision å€’åºæ’åˆ—ï¼Œåªå–ä¸€ä¸ª</span></span><br><span class="line">  <span class="comment">// v3.WithMaxCreateRev(maxCreateRev) å…³æ³¨çš„keyçš„Revisionæœ€å¤§ä¸º maxCreateRev</span></span><br><span class="line">  getOpts := <span class="built_in">append</span>(v3.WithLastCreate(), v3.WithMaxCreateRev(maxCreateRev))</span><br><span class="line">	</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆè·å–å…³æ³¨å¹¶ä¸”å°†è¦ watch çš„ key çš„ä¿¡æ¯</span></span><br><span class="line">		resp, err := client.Get(ctx, pfx, getOpts...)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(resp.Kvs) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> resp.Header, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç›‘å¬çš„ keyï¼Œå³ï¼šæ¯”è‡ªå·±Revisionå°å¹¶ä¸”è·ç¦»è‡ªå·±Revisionæœ€è¿‘çš„key</span></span><br><span class="line">		lastKey := <span class="type">string</span>(resp.Kvs[<span class="number">0</span>].Key)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// waitDelete ä¸­ ç›‘å¬key</span></span><br><span class="line">    <span class="comment">// å…³æ³¨çš„ key æ— äº‹ä»¶å‘ç”Ÿï¼Œåˆ™ä¸€ç›´é˜»å¡</span></span><br><span class="line">    <span class="comment">// resp.Header.Revision ä¸º å¯¹åº”çš„keyçš„ Revision</span></span><br><span class="line">		<span class="keyword">if</span> err = waitDelete(ctx, client, lastKey, resp.Header.Revision); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">waitDelete</span><span class="params">(ctx context.Context, client *v3.Client, key <span class="type">string</span>, rev <span class="type">int64</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	cctx, cancel := context.WithCancel(ctx)</span><br><span class="line">	<span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> wr v3.WatchResponse</span><br><span class="line">  <span class="comment">// å¯¹ key è¿›è¡Œç›‘å¬</span></span><br><span class="line">  <span class="comment">// rev ä¸º key çš„ Revision</span></span><br><span class="line">	wch := client.Watch(cctx, key, v3.WithRev(rev))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// keyæœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿä¹‹åï¼Œéƒ½ä¼šä» wch ä¸­è·å–çš„åˆ°äº‹ä»¶ä¿¡æ¯</span></span><br><span class="line">	<span class="keyword">for</span> wr = <span class="keyword">range</span> wch &#123;</span><br><span class="line">		<span class="keyword">for</span> _, ev := <span class="keyword">range</span> wr.Events &#123;</span><br><span class="line">      <span class="comment">// åªå…³æ³¨ åˆ é™¤äº‹ä»¶</span></span><br><span class="line">      <span class="comment">// æ­£å¸¸æƒ…å†µä¸‹ï¼Œåªæœ‰ åˆ é™¤äº‹ä»¶å‘ç”Ÿï¼Œæ‰ä¼šé€€å‡º</span></span><br><span class="line">			<span class="keyword">if</span> ev.Type == mvccpb.DELETE &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := wr.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := ctx.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;lost watcher waiting for delete&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>å¯¹åˆ é™¤key Unlock() æ–¹æ³•çš„è§£è¯»ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Unlock(ctx context.Context) <span class="type">error</span> &#123;</span><br><span class="line">	client := m.s.Client()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯·æ±‚ etcd server å¯¹keyè¿›è¡Œåˆ é™¤æ“ä½œ</span></span><br><span class="line">	<span class="keyword">if</span> _, err := client.Delete(ctx, m.myKey); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æŠŠ m.myKey é‡ç½®ä¸º ASCII ç å€¼ä¸º 0 çš„å­—ç¬¦ï¼Œå³ï¼š</span></span><br><span class="line">	m.myKey = <span class="string">&quot;\x00&quot;</span></span><br><span class="line">	m.myRev = <span class="number">-1</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/07/1757855868.png">


<h2 id="6-å°ç»“"><a href="#6-å°ç»“" class="headerlink" title="6.å°ç»“"></a>6.å°ç»“</h2><p>å¥½çš„åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡ä¸€ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li><p>äº’æ–¥æ€§ï¼šä»»æ„æ—¶åˆ»ï¼ŒåŒä¸€ä¸ªé”ï¼Œåªæœ‰ä¸€ä¸ªæ“ä½œå¯¹è±¡èƒ½æŒæœ‰</p>
<blockquote>
<p>etcd é€šè¿‡å¯¹keyçš„ç›¸åŒå‰ç¼€åŠ é”ï¼ŒRevision æœ€å°è€…è·å¾—é”å®ç°</p>
</blockquote>
</li>
<li><p>å®‰å…¨æ€§ï¼šé¿å…æ­»é”ï¼Œå½“è¿›ç¨‹æ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”ï¼ˆè¿›ç¨‹å´©æºƒé€€å‡ºï¼‰ï¼Œä¿è¯å…¶ä»–è¿›ç¨‹èƒ½å¤ŸåŠ é”</p>
<blockquote>
<p>etcd é€šè¿‡å¯¹keyçš„ç›¸åŒå‰ç¼€åŠ é”ï¼ŒRevision éæœ€å°è€…åˆ›å»ºkeyå¹¶é˜»å¡ç­‰å¾…</p>
</blockquote>
</li>
<li><p>å¯ç”¨æ€§ï¼šå½“æä¾›é”çš„æœåŠ¡èŠ‚ç‚¹æ•…éšœï¼ˆå®•æœºï¼‰æ—¶ï¼Œçƒ­å¤‡èŠ‚ç‚¹èƒ½å¤Ÿæ¥æ›¿æ•…éšœçš„èŠ‚ç‚¹ç»§ç»­æä¾›æœåŠ¡ï¼Œå¹¶ä¿è¯è‡ªèº«æŒæœ‰çš„æ•°æ®ä¸æ•…éšœèŠ‚ç‚¹ä¸€è‡´</p>
<blockquote>
<p>etcd server é€šè¿‡raftä¸€è‡´æ€§ç®—æ³•æ¥ä¿è¯<br>redis çš„ä¸»ä»é›†ç¾¤ æˆ–è€… Redlockç®—æ³• åœ¨è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜</p>
</blockquote>
</li>
<li><p>å¯¹ç§°æ€§ï¼šå¯¹åŒä¸€ä¸ªé”ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»æ˜¯åŒä¸€ä¸ªè¿›ç¨‹ï¼Œå³æŸè¿›ç¨‹ä¸èƒ½æŠŠå…¶ä»–è¿›ç¨‹æŒæœ‰çš„é”ç»™é‡Šæ”¾äº†</p>
<blockquote>
<p>æ¯ä¸€ä¸ªåŠ é”å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª mutex å¯¹è±¡ï¼Œè§£é”æ—¶åˆ é™¤çš„æ˜¯ å®Œæ•´çš„ key åç§°ï¼Œè€Œéå‰ç¼€ã€‚etcd ä½¿ç”¨ <code>keyå‰ç¼€+uuid</code> ä¿è¯äº†keyçš„å”¯ä¸€æ€§</p>
</blockquote>
</li>
</ul>
<p>é€šè¿‡æºç è§£è¯»ï¼Œå¯çŸ¥ etcd å…·å¤‡ä¸Šè¿°ç‰¹æ€§ï¼Œå¹¶ä¸”æ˜¯ä¸€æŠŠåˆæ ¼çš„åˆ†å¸ƒå¼é”ã€‚</p>
<h2 id="7-æ‰©å±•é˜…è¯»"><a href="#7-æ‰©å±•é˜…è¯»" class="headerlink" title="7.æ‰©å±•é˜…è¯»"></a>7.æ‰©å±•é˜…è¯»</h2><ul>
<li><a target="_blank" rel="noopener" href="https://doczhcn.gitbook.io/etcd/index/index/interacting_v3">https://doczhcn.gitbook.io/etcd/index/index/interacting_v3</a> etcdäº¤äº’</li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/FengZeng666/p/16156407.html">https://www.cnblogs.com/FengZeng666/p/16156407.html</a> etcdä¸­Revision&#x2F;CreateRevision&#x2F;ModRevision&#x2F;Versionå«ä¹‰</li>
<li><a target="_blank" rel="noopener" href="https://pandaychen.github.io/2020/05/30/A-ETCD-COOKBOOK/">https://pandaychen.github.io/2020/05/30/A-ETCD-COOKBOOK/</a></li>
<li><a target="_blank" rel="noopener" href="https://pandaychen.github.io/2019/10/24/ETCD-DISTRIBUTED-LOCK/">https://pandaychen.github.io/2019/10/24/ETCD-DISTRIBUTED-LOCK/</a></li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="å¤´åƒ"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/xiaowangzi.jpg" title="å¤´åƒ" alt="å¤´åƒ"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/xiaowangzi.jpg" title="å¤´åƒ" alt="å¤´åƒ"></a><div class="post-copyright__author_name">ivansli</div><div class="post-copyright__author_desc">å­¦æ— æ­¢å¢ƒ</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="è¯¥æ–‡ç« ä¸ºåŸåˆ›æ–‡ç« ï¼Œæ³¨æ„ç‰ˆæƒåè®®" href="https://blog.ivansli.com/2021/05/24/etcd-lock/">åŸåˆ›</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.ivansli.com/2021/05/24/etcd-lock/')">etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="èµèµä½œè€…"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>æ‰“èµä½œè€…</div><div class="reward-main"><div class="reward-all"><!--span.reward-title æ„Ÿè°¢ä½ èµäºˆæˆ‘å‰è¿›çš„åŠ›é‡--><ul class="reward-group"><li class="reward-item"><a href="/img/reward/wechat-small.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/wechat-small.png" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="/img/reward/alipay-small.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/reward/alipay-small.png" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul><!--a.reward-main-btn(href='/about/#about-reward' target='_blank')//.reward-text èµèµè€…åå•
//.reward-dec å› ä¸ºä½ ä»¬çš„æ”¯æŒè®©æˆ‘æ„è¯†åˆ°å†™æ–‡ç« çš„ä»·å€¼ğŸ™--></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« "><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.ivansli.com/2021/05/24/etcd-lock/"></div><div class="reward-dec">ä½¿ç”¨æ‰‹æœºè®¿é—®è¿™ç¯‡æ–‡ç« </div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=etcdä¸åˆ†å¸ƒå¼é”çš„å®ç°åŠåŸç†&amp;url=https://blog.ivansli.com/2021/05/24/etcd-lock/&amp;pic=/img/space-man-small.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="å¤åˆ¶é“¾æ¥" onclick="rm.copyPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">æœ¬æ–‡ç³»åŸåˆ›ä½œå“ï¼Œç‰ˆæƒæ‰€æœ‰ï¼ˆç¦æ­¢è½¬è½½ï¼‰</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ä¸­é—´ä»¶<span class="tagsPageCount">13</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="/img/2024/07/helm.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/05/23/linux-crontab/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/space-man-small.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">crontabå®šæ—¶ä»»åŠ¡è®¾ç½®è¶…æ—¶ã€äº’æ–¥</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/25/about-unix/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2021/11/1965466339.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Unixä¼ å¥‡å‘å±•å²</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>å–œæ¬¢è¿™ç¯‡æ–‡ç« çš„äººä¹Ÿçœ‹äº†</span></div><div class="relatedPosts-list"><div><a href="/2023/04/26/230426-redis-server/" title="redisServerã€redisDBä¸æ•°æ®å­—å…¸dict"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/04/redis-server-layout.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-26</div><div class="title">redisServerã€redisDBä¸æ•°æ®å­—å…¸dict</div></div></a></div><div><a href="/2023/04/27/230427-redis-config/" title="å…³äºRedisé…ç½®ä¿¡æ¯åˆå§‹åŒ–"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/04/redis-config-001.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-04-27</div><div class="title">å…³äºRedisé…ç½®ä¿¡æ¯åˆå§‹åŒ–</div></div></a></div><div><a href="/2023/05/30/230530-redis-event-driven/" title="Redisäº‹ä»¶é©±åŠ¨(aeEventLoop)åŸç†åˆ†æ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/05/2023530-01.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-05-30</div><div class="title">Redisäº‹ä»¶é©±åŠ¨(aeEventLoop)åŸç†åˆ†æ</div></div></a></div><div><a href="/2023/06/02/230602-redis-cluster-hashtag/" title="Redis Clusteré›†ç¾¤hash tagåŸç†åˆ†æ"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/06/230602-01.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-06-02</div><div class="title">Redis Clusteré›†ç¾¤hash tagåŸç†åˆ†æ</div></div></a></div><div><a href="/2021/05/18/distributed-lock/" title="ä½¿ç”¨åˆ†å¸ƒå¼é”æ—¶è¦è€ƒè™‘çš„äº‹æƒ…"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/space-man-small.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2021-05-18</div><div class="title">ä½¿ç”¨åˆ†å¸ƒå¼é”æ—¶è¦è€ƒè™‘çš„äº‹æƒ…</div></div></a></div><div><a href="/2022/06/21/gitlab-ci-cd/" title="åŸºäºdockeræ­å»ºçš„gitlabå®ç°CI&#x2F;CD"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2022/06/312466126.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2022-06-21</div><div class="title">åŸºäºdockeræ­å»ºçš„gitlabå®ç°CI&#x2F;CD</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/xiaowangzi.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/goutou.png" ait="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">è¿™é‡Œæœ‰<b style="color:#fff">çŸ¥è¯†æ€»ç»“</b>å’Œ<b style="color:#fff">æŠ€æœ¯åˆ†äº«</b>ã€‚ä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸã€‚<b style="color:#fff">æ­¤ç”Ÿä¹Ÿæœ‰æ¶¯</b>ï¼Œ<b style="color:#fff">æ­¤ç”Ÿå­¦æ— æ¶¯</b>ã€‚</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">ivansli</h1><div class="author-info__desc">å­¦æ— æ­¢å¢ƒ</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/coderstart" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>æ–‡ç« ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%85%B3%E4%BA%8Eetcd"><span class="toc-number">1.</span> <span class="toc-text">1.å…³äºetcd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E7%BB%84%E4%BB%B6%E4%BB%AC"><span class="toc-number">2.</span> <span class="toc-text">2.å®ç°åˆ†å¸ƒå¼é”çš„ç»„ä»¶ä»¬</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-etcd%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">3.etcdåˆ†å¸ƒå¼é”å®ç°åŸç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-etcd%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">4.etcdåˆ†å¸ƒå¼é”ç¤ºä¾‹ä»£ç </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="toc-number">5.</span> <span class="toc-text">5.æºç è§£è¯»</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%B0%8F%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">6.å°ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB"><span class="toc-number">7.</span> <span class="toc-text">7.æ‰©å±•é˜…è¯»</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>æœ€è¿‘å‘å¸ƒ</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/07/240707-helm/" title="helmçš„å®‰è£…/ä½¿ç”¨åŠå…¶è¿è¡ŒåŸç†"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2024/07/helm.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="helmçš„å®‰è£…/ä½¿ç”¨åŠå…¶è¿è¡ŒåŸç†"/></a><div class="content"><a class="title" href="/2024/07/07/240707-helm/" title="helmçš„å®‰è£…/ä½¿ç”¨åŠå…¶è¿è¡ŒåŸç†">helmçš„å®‰è£…/ä½¿ç”¨åŠå…¶è¿è¡ŒåŸç†</a><time datetime="2024-07-07T01:00:00.000Z" title="å‘è¡¨äº 2024-07-07 09:00:00">2024-07-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/11/11/theroadtoserfdom/" title="è¯»ï¼šå“ˆè€¶å…‹ã€Šåˆ°å¥´å½¹ä¹‹è·¯ã€‹æœ‰æ„Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/11/hayeke.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è¯»ï¼šå“ˆè€¶å…‹ã€Šåˆ°å¥´å½¹ä¹‹è·¯ã€‹æœ‰æ„Ÿ"/></a><div class="content"><a class="title" href="/2023/11/11/theroadtoserfdom/" title="è¯»ï¼šå“ˆè€¶å…‹ã€Šåˆ°å¥´å½¹ä¹‹è·¯ã€‹æœ‰æ„Ÿ">è¯»ï¼šå“ˆè€¶å…‹ã€Šåˆ°å¥´å½¹ä¹‹è·¯ã€‹æœ‰æ„Ÿ</a><time datetime="2023-11-11T01:44:00.000Z" title="å‘è¡¨äº 2023-11-11 09:44:00">2023-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/07/231007-game-theory3/" title="äºŒäººé›¶å’Œåšå¼ˆä¸æœ€å¤§æœ€å°å®šç†"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/09/gametheory-01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="äºŒäººé›¶å’Œåšå¼ˆä¸æœ€å¤§æœ€å°å®šç†"/></a><div class="content"><a class="title" href="/2023/10/07/231007-game-theory3/" title="äºŒäººé›¶å’Œåšå¼ˆä¸æœ€å¤§æœ€å°å®šç†">äºŒäººé›¶å’Œåšå¼ˆä¸æœ€å¤§æœ€å°å®šç†</a><time datetime="2023-10-07T08:45:00.000Z" title="å‘è¡¨äº 2023-10-07 16:45:00">2023-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/10/07/231007-game-theory2/" title="åšå¼ˆè®ºå¯¹ä¸€èˆ¬é—®é¢˜çš„å»ºæ¨¡åˆ†æ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/09/gametheory-01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="åšå¼ˆè®ºå¯¹ä¸€èˆ¬é—®é¢˜çš„å»ºæ¨¡åˆ†æ"/></a><div class="content"><a class="title" href="/2023/10/07/231007-game-theory2/" title="åšå¼ˆè®ºå¯¹ä¸€èˆ¬é—®é¢˜çš„å»ºæ¨¡åˆ†æ">åšå¼ˆè®ºå¯¹ä¸€èˆ¬é—®é¢˜çš„å»ºæ¨¡åˆ†æ</a><time datetime="2023-10-07T03:40:00.000Z" title="å‘è¡¨äº 2023-10-07 11:40:00">2023-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/09/18/230918-game-theory/" title="è®¤è¯†åšå¼ˆè®º"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/2023/09/gametheory-01.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="è®¤è¯†åšå¼ˆè®º"/></a><div class="content"><a class="title" href="/2023/09/18/230918-game-theory/" title="è®¤è¯†åšå¼ˆè®º">è®¤è¯†åšå¼ˆè®º</a><time datetime="2023-09-18T10:00:00.000Z" title="å‘è¡¨äº 2023-09-18 18:00:00">2023-09-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><!-- - let centerImg = theme.footer.socialBar.centerImg ? theme.footer.socialBar.centerImg : theme.avatar.img--><div id="footer_deal"><!-- å·¦ä¾§å›¾æ ‡--><a class="deal_link" href="mailto:gopher001@outlook.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><!--ä¸ªäººå¤´åƒå›¾æ ‡--><!--img.footer_mini_logo(title="è¿”å›é¡¶éƒ¨", alt="è¿”å›é¡¶éƒ¨" onclick="anzhiyu.scrollToDest(0, 500)", src=centerImg, size="50px")--><!-- å³ä¾§å›¾æ ‡--><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/coderstart" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">å¯¼èˆª</div><div class="footer-links"><a class="footer-item" title="æ–‡ç« åˆ—è¡¨" href="/archives/">æ–‡ç« åˆ—è¡¨</a><a class="footer-item" title="æˆ‘çš„ä¹¦å•" href="/booklist/">æˆ‘çš„ä¹¦å•</a><a class="footer-item" title="æå®¢è¯´è¯´" href="/essay/">æå®¢è¯´è¯´</a><a class="footer-item" title="å…³äºæœ¬ç«™" href="/about/">å…³äºæœ¬ç«™</a></div></div><div class="footer-group"><div class="footer-title">åˆ†ç±»</div><div class="footer-links"><a class="footer-item" title="ç¼–ç¨‹åŸç†" href="/categories/%E7%BC%96%E7%A8%8B%E5%8E%9F%E7%90%86/">ç¼–ç¨‹åŸç†</a><a class="footer-item" title="ç³»ç»Ÿæ¶æ„" href="/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">ç³»ç»Ÿæ¶æ„</a><a class="footer-item" title="ä¸­é—´ä»¶" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶</a><a class="footer-item" title="ç¼–ç¨‹åŸç†" href="/categories/%E7%BC%96%E7%A8%8B%E5%8E%9F%E7%90%86/">ç¼–ç¨‹åŸç†</a></div></div><div class="footer-group"><div class="footer-title">åè®®</div><div class="footer-links"><a class="footer-item" title="éšç§åè®®" href="/privacy/">éšç§åè®®</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="ç‰ˆæƒåè®®" href="/copyright/">ç‰ˆæƒåè®®</a></div></div><div class="footer-group"><div class="footer-title">å‹é“¾</div><div class="footer-links"><a class="footer-item" title="ç¼–ç¨‹å¯¼èˆª" href="/tool/">ç¼–ç¨‹å¯¼èˆª</a></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" style="margin-inline:5px" data-title="åšå®¢æ¡†æ¶ä¸ºHexo" title="åšå®¢æ¡†æ¶ä¸ºHexo"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/badge/Frame-Hexo.svg" alt="åšå®¢æ¡†æ¶ä¸ºHexo"/></a><a class="github-badge" target="_blank" style="margin-inline:5px" data-title="æœ¬ç«™ä½¿ç”¨AnZhiYuä¸»é¢˜" title="æœ¬ç«™ä½¿ç”¨AnZhiYuä¸»é¢˜"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/badge/Theme-AnZhiYu-2E67D3.svg" alt="æœ¬ç«™ä½¿ç”¨AnZhiYuä¸»é¢˜"/></a><a class="github-badge" target="_blank" style="margin-inline:5px" data-title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯" title="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/badge/Copyright-BY-NC-SA.svg" alt="æœ¬ç«™é‡‡ç”¨çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«4.0å›½é™…è®¸å¯åè®®è¿›è¡Œè®¸å¯"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2019 - 2024 Â· <a class="footer-bar-link" href="/" title="ivansli" target="_blank">ivansli</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="http://beian.miit.gov.cn" title="æ²ªICPå¤‡2021031949å·">æ²ªICPå¤‡2021031949å·</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://tool.ivansli.com" title="ç¼–ç¨‹å¯¼èˆª">ç¼–ç¨‹å¯¼èˆª</a><a class="footer-bar-link cc" href="/" title="ccåè®®"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">æ–‡ç« </div><div class="length-num">80</div></a><a href="/tags/" title="tag"><div class="headline">æ ‡ç­¾</div><div class="length-num">37</div></a><a href="/categories/" title="category"><div class="headline">åˆ†ç±»</div><div class="length-num">20</div></a></div><span class="sidebar-menu-item-title">åŠŸèƒ½</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="æ˜¾ç¤ºæ¨¡å¼"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>æ˜¾ç¤ºæ¨¡å¼</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="anzhiyufont anzhiyu-icon-house-chimney faa-tada"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/booklist/"><i class="anzhiyufont anzhiyu-icon-book faa-tada"></i><span> ä¹¦å•</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada"></i><span> å…³äº</span></a></div></div><span class="sidebar-menu-item-title">æ ‡ç­¾</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Apple/" style="font-size: 0.88rem;">Apple<sup>2</sup></a><a href="/tags/CI-CD/" style="font-size: 0.88rem;">CI/CD<sup>1</sup></a><a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 0.88rem;">Cè¯­è¨€<sup>1</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>2</sup></a><a href="/tags/IoT/" style="font-size: 0.88rem;">IoT<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>2</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>5</sup></a><a href="/tags/PHP/" style="font-size: 0.88rem;">PHP<sup>1</sup></a><a href="/tags/Python/" style="font-size: 0.88rem;">Python<sup>1</sup></a><a href="/tags/Unix/" style="font-size: 0.88rem;">Unix<sup>2</sup></a><a href="/tags/ZooKeeper/" style="font-size: 0.88rem;">ZooKeeper<sup>1</sup></a><a href="/tags/crontab/" style="font-size: 0.88rem;">crontab<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>4</sup></a><a href="/tags/gitlab/" style="font-size: 0.88rem;">gitlab<sup>1</sup></a><a href="/tags/golang/" style="font-size: 0.88rem;">golang<sup>31</sup></a><a href="/tags/grpc-go/" style="font-size: 0.88rem;">grpc-go<sup>3</sup></a><a href="/tags/k8s/" style="font-size: 0.88rem;">k8s<sup>1</sup></a><a href="/tags/redis/" style="font-size: 0.88rem;">redis<sup>6</sup></a><a href="/tags/%E4%B8%AD%E6%96%87%E7%BC%96%E7%A8%8B/" style="font-size: 0.88rem;">ä¸­æ–‡ç¼–ç¨‹<sup>1</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">ä¸­é—´ä»¶<sup>13</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8FID/" style="font-size: 0.88rem;">åˆ†å¸ƒå¼ID<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 0.88rem;">åˆ†å¸ƒå¼é”<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%BC%88%E8%AE%BA/" style="font-size: 0.88rem;">åšå¼ˆè®º<sup>3</sup></a><a href="/tags/%E5%8F%B7%E6%AE%B5%E5%8F%91%E5%8F%B7%E5%99%A8/" style="font-size: 0.88rem;">å·æ®µå‘å·å™¨<sup>1</sup></a><a href="/tags/%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" style="font-size: 0.88rem;">å¸¸è§é—®é¢˜<sup>6</sup></a><a href="/tags/%E6%8C%87%E6%95%B0%E9%80%80%E9%81%BF/" style="font-size: 0.88rem;">æŒ‡æ•°é€€é¿<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 0.88rem;">æ•°æ®åº“<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 0.88rem;">æ¶ˆæ¯é˜Ÿåˆ—<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95%E6%8A%80%E5%B7%A7/" style="font-size: 0.88rem;">ç®—æ³•æŠ€å·§<sup>6</sup></a><a href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">ç³»ç»Ÿæ¶æ„<sup>5</sup></a><a href="/tags/%E7%BB%8F%E6%B5%8E%E5%AD%A6/" style="font-size: 0.88rem;">ç»æµå­¦<sup>4</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%8E%86%E5%8F%B2/" style="font-size: 0.88rem;">ç¼–ç¨‹å†å²<sup>8</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%8E%9F%E7%90%86/" style="font-size: 0.88rem;">ç¼–ç¨‹åŸç†<sup>31</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">ç¼–ç¨‹å·¥å…·<sup>1</sup></a><a href="/tags/%E8%81%8C%E5%9C%BA%E5%BF%83%E5%A3%B0/" style="font-size: 0.88rem;">èŒåœºå¿ƒå£°<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">è½¯ä»¶å·¥å…·<sup>2</sup></a><a href="/tags/%E9%9D%A2%E8%AF%95%E7%BB%8F%E9%AA%8C/" style="font-size: 0.88rem;">é¢è¯•ç»éªŒ<sup>4</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶é€‰ä¸­æ–‡æœ¬</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>ç²˜è´´æ–‡æœ¬</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>å¼•ç”¨åˆ°è¯„è®º</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>å¤åˆ¶é“¾æ¥åœ°å€</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>å¤åˆ¶æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>ä¸‹è½½æ­¤å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>æ–°çª—å£æ‰“å¼€å›¾ç‰‡</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç«™å†…æœç´¢</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>ç™¾åº¦æœç´¢</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>æ’­æ”¾éŸ³ä¹</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>åˆ‡æ¢åˆ°ä¸Šä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>åˆ‡æ¢åˆ°ä¸‹ä¸€é¦–</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>æŸ¥çœ‹æ‰€æœ‰æ­Œæ›²</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶æ­Œå</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>åšå®¢åˆ†ç±»</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>æ–‡ç« æ ‡ç­¾</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>å¤åˆ¶åœ°å€</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">å…³é—­çƒ­è¯„</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">æ·±è‰²æ¨¡å¼</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>è½‰ç‚ºç¹é«”</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/instant.page/instantpage.js" type="module"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/pluginsSrc/node-snackbar/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script async data-pjax src="/pluginsSrc/anzhiyu-theme-static/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="/pluginsSrc/anzhiyu-theme-static/icon/ali_iconfont_css.css"><script defer="defer" id="fluttering_ribbon" mobile="true" src="/pluginsSrc/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="/pluginsSrc/anzhiyu-theme-static/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/anzhiyu-blog-static/js/APlayer.min.js"></script><script src="/pluginsSrc/hexo-anzhiyu-music/assets/js/Meting2.min.js"></script><script src="/pluginsSrc/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="/pluginsSrc/anzhiyu-theme-static/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">é€šçŸ¥</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">ä½ å¥½å‘€</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>